{% load static %}

<style>
    body {
        font-family: Arial, sans-serif;
    }

    .btn {
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-dark {
        background: #333;
        color: white;
    }

    table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
    }

    th, td {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }

    th {
        background: #f9f9f9;
        text-align: left;
    }

    #popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: none;
        justify-content: center;
        align-items: center;
    }

    #popup-content {
        background: white;
        padding: 30px;
        width: 480px;
        border-radius: 10px;
        box-shadow: 0px 0px 20px rgba(0,0,0,0.2);
    }

    #busca {
        margin-left: 20px;
        padding: 10px 14px;
        width: 300px;
        border: 1px solid #ccc;
        border-radius: 6px;
    }

    tr:hover {
        background: #fafafa;
    }
</style>

<div style="padding: 25px;">

    <h1 style="font-size: 30px; margin-bottom: 20px;">
        Lista de Seriais Registrados
    </h1>

    <button onclick="abrirModalNovo()" class="btn btn-primary">
        + Adicionar Serial
    </button>

    <input type="text" id="busca" placeholder="Buscar..."
           onkeyup="debounceBuscar(this.value)">
</div>


<!-- TABELA DINÂMICA -->
<div id="tabela-seriais">
    {% include "serial_vci/_tabela.html" %}
</div>


<!-- POPUP DETALHES -->
<div id="popup" onclick="fecharPopup()">
    <div id="popup-content" onclick="event.stopPropagation()">
        <h2>Detalhes do Serial</h2>
        <div id="conteudo-detalhes"></div>

        <button onclick="fecharPopup()" class="btn btn-primary" style="margin-top:20px;">
            Fechar
        </button>
    </div>
</div>

<!-- POPUP NOVO SERIAL -->
<div id="modal-novo" onclick="fecharModalNovo()"
     style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,0.6);justify-content:center;align-items:center;">
    
    <div onclick="event.stopPropagation()"
         style="background:white;padding:30px;width:480px;border-radius:10px;box-shadow:0px 0px 20px rgba(0,0,0,0.2);">
        
        <h2>Novo Serial</h2>

        <form id="form-novo-serial" enctype="multipart/form-data">
            <label>VCI</label>
            <input name="numero_vci" class="form-control" required>

            <label>Tablet</label>
            <input name="numero_tablet" class="form-control">

            <label>Prog</label>
            <input name="numero_prog" class="form-control">

            <label>Cliente</label>
            <input name="cliente" class="form-control">

            <label>Email</label>
            <input name="email" type="email" class="form-control">

            <label>Telefone</label>
            <input name="telefone" class="form-control">

            <label>Pedido</label>
            <input name="pedido" class="form-control">

            <label>Fotos (múltiplas)</label>
            <input type="file" name="fotos" multiple>

            <button type="button" onclick="salvarNovoSerial()" class="btn btn-primary" style="margin-top:20px;">
                Salvar
            </button>
        </form>

        <button onclick="fecharModalNovo()" class="btn btn-dark" style="margin-top:10px;">
            Cancelar
        </button>
    </div>
</div>


<script>
/* ===========================
   BUSCA + PAGINAÇÃO AJAX
=========================== */

let timer = null;
let paginaAtual = 1;

function debounceBuscar(valor) {
    clearTimeout(timer);
    timer = setTimeout(() => buscar(valor), 300);
}

function buscar(valor) {
    fetch(`/seriais/?q=${encodeURIComponent(valor)}&page=${paginaAtual}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
        .then(res => res.text())
        .then(html => {
            document.getElementById("tabela-seriais").innerHTML = html;
        });
}

function mudarPagina(pagina) {
    paginaAtual = pagina;
    buscar(document.getElementById("busca").value);
}

/* ===========================
   POPUP DETALHES
=========================== */

function abrirDetalhes(id) {
    fetch(`/seriais/detalhes/${id}/`)
        .then(res => res.json())
        .then(data => {
            let html = `
                <p><b>VCI:</b> ${data.numero_vci}</p>
                <p><b>Tablet:</b> ${data.numero_tablet}</p>
                <p><b>Prog:</b> ${data.numero_prog}</p>
                <p><b>Cliente:</b> ${data.cliente}</p>
                <p><b>Email:</b> ${data.email}</p>
                <p><b>Telefone:</b> ${data.telefone}</p>
                <p><b>Pedido:</b> ${data.pedido}</p>
                <p><b>Fotos:</b></p>
            `;

            data.fotos.forEach(url => {
                html += `<img src="${url}" style="width:80px;margin:5px;border-radius:4px;">`;
            });

            document.getElementById("conteudo-detalhes").innerHTML = html;
            document.getElementById("popup").style.display = "flex";
        });
}

function fecharPopup() {
    document.getElementById("popup").style.display = "none";
}


/* ===========================
   WEBSOCKET REALTIME
=========================== */

const socket = new WebSocket(
    "ws://" + window.location.host + "/ws/seriais/"
);

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.mensagem === "atualizar_tabela") {
        buscar(document.getElementById("busca").value);
    }
};

/* ===========================
   MODAL NOVO SERIAL
=========================== */

function abrirModalNovo() {
    document.getElementById("modal-novo").style.display = "flex";
}

function fecharModalNovo() {
    document.getElementById("modal-novo").style.display = "none";
}

function salvarNovoSerial() {
    const form = document.getElementById("form-novo-serial");
    const formData = new FormData(form);

    fetch("/seriais/adicionar/", {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        body: formData
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                fecharModalNovo();
                buscar(document.getElementById("busca").value); // refresca tabela
            } else {
                alert("Erro: " + JSON.stringify(data.errors));
            }
        });
}

/* Função utilitária para pegar o CSRF */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

</script>

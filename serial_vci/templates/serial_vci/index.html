{% load static %}

<style>
    body {
        font-family: Arial, sans-serif;
    }

    .btn {
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-dark {
        background: #333;
        color: white;
    }

    table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
    }

    th, td {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }

    th {
        background: #f9f9f9;
        text-align: left;
    }

    #popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: none;
        justify-content: center;
        align-items: center;
    }

    #popup-content {
        background: white;
        padding: 30px;
        width: 480px;
        border-radius: 10px;
        box-shadow: 0px 0px 20px rgba(0,0,0,0.2);
    }

    #busca {
        margin-left: 20px;
        padding: 10px 14px;
        width: 300px;
        border: 1px solid #ccc;
        border-radius: 6px;
    }

    tr:hover {
        background: #fafafa;
    }

    .input {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-top: 5px;
        font-size: 14px;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    
    /* CORREÇÃO VISUAL DAS FOTOS */
    .foto-miniatura {
        width: 80px;
        height: 80px;
        object-fit: cover; /* Garante que a imagem preencha o espaço sem distorcer */
        margin: 5px;
        border-radius: 4px;
    }
</style>

<div style="padding: 25px;">

    <h1 style="font-size: 30px; margin-bottom: 20px;">
        Lista de Seriais Registrados
    </h1>

    <button onclick="abrirModalNovo()" class="btn btn-primary">
        + Adicionar Serial
    </button>

    <input type="text" id="busca" placeholder="Buscar..."
           onkeyup="debounceBuscar(this.value)">
</div>


<div id="tabela-seriais">
    {% include "serial_vci/_tabela.html" %}
</div>


<div id="popup" onclick="fecharPopup()">
    <div id="popup-content" onclick="event.stopPropagation()">
        <h2>Detalhes do Serial</h2>
        <div id="conteudo-detalhes"></div>

        <button onclick="fecharPopup()" class="btn btn-dark" style="margin-top:20px;">
            Fechar
        </button>
    </div>
</div>

<div id="modal-novo" onclick="fecharModalNovo()"
     style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:9999">

    <div onclick="event.stopPropagation()"
         style="background:white;padding:30px;width:520px;border-radius:12px;
                box-shadow:0px 4px 20px rgba(0,0,0,0.25);animation:fadeIn .2s ease;">

        <h2 style="margin-top:0;margin-bottom:20px;font-size:26px;">Novo Serial</h2>

        <form id="form-novo-serial" enctype="multipart/form-data">
            {% csrf_token %}

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">

                <div style="grid-column: span 2;">
                    <label>VCI</label>
                    <input name="numero_vci" class="input" required>
                </div>

                <div>
                    <label>Tablet</label>
                    <input name="numero_tablet" class="input">
                </div>

                <div>
                    <label>Prog</label>
                    <input name="numero_prog" class="input">
                </div>

                <div>
                    <label>Cliente</label>
                    <input name="cliente" class="input" required>
                </div>

                <div>
                    <label>Email</label>
                    <input name="email" type="email" class="input" required>
                </div>

                <div>
                    <label>Telefone</label>
                    <input name="telefone" class="input">
                </div>

                <div>
                    <label>Pedido</label>
                    <input name="pedido" class="input" required>
                </div>

                <div style="grid-column: span 2;">
                    <label>Fotos (múltiplas)</label>

                    <div id="preview-container" 
                        style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;"></div>

                    <input type="file" id="input-fotos" multiple accept="image/*"
                        style="display:none" onchange="handleAddImages(event)">

                    <button type="button" onclick="document.getElementById('input-fotos').click()"
                            class="btn btn-primary" style="margin-top:10px;">
                        + Adicionar fotos
                    </button>
                </div>

            </div>

            <div style="margin-top:25px;display:flex;justify-content:space-between;align-items:center;">
                <button type="button" onclick="fecharModalNovo()" class="btn btn-dark">Cancelar</button>
                <button type="button" onclick="salvarNovoSerial()" class="btn btn-primary">Salvar</button>
            </div>

        </form>
    </div>
</div>

<div id="modal-edicao" onclick="fecharModalEdicao()"
     style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:9999">

    <div onclick="event.stopPropagation()"
         style="background:white;padding:30px;width:520px;border-radius:12px;
                box-shadow:0px 4px 20px rgba(0,0,0,0.25);animation:fadeIn .2s ease;">

        <h2 style="margin-top:0;margin-bottom:20px;font-size:26px;">
            Editar Serial <span id="edicao-serial-id-text"></span>
        </h2>
        
        <form id="form-edicao-serial" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="serial_id" id="edicao-serial-id">

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                
                <div style="grid-column: span 2;">
                    <label>VCI</label>
                    <input name="numero_vci" class="input" id="edicao-numero_vci" required>
                </div>

                <div>
                    <label>Tablet</label>
                    <input name="numero_tablet" class="input" id="edicao-numero_tablet">
                </div>

                <div>
                    <label>Prog</label>
                    <input name="numero_prog" class="input" id="edicao-numero_prog">
                </div>
                
                <div style="grid-column: span 2;">
                    <label>Fotos Existentes (Clique na ✕ para remover)</label>
                    <div id="preview-edicao-existente-container" 
                        style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;margin-bottom:15px;"></div>

                    <label>Adicionar Novas Fotos</label>
                    <div id="preview-edicao-nova-container" 
                        style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;"></div>

                    <input type="file" id="input-fotos-edicao" multiple accept="image/*"
                        style="display:none" onchange="handleAddImagesEdicao(event)">

                    <button type="button" onclick="document.getElementById('input-fotos-edicao').click()"
                            class="btn btn-primary" style="margin-top:10px;">
                        + Adicionar mais fotos
                    </button>
                </div>

            </div>

            <div style="margin-top:25px;display:flex;justify-content:space-between;align-items:center;">
                <button type="button" onclick="fecharModalEdicao()" class="btn btn-dark">Cancelar</button>
                <button type="button" onclick="salvarEdicaoSerial()" class="btn btn-primary">Salvar Edição</button>
            </div>

        </form>
    </div>
</div>

<script>
/* =======================================
   VARIÁVEIS GLOBAIS
======================================= */
let fotosSelecionadasNovo = []; // para o modal de NOVO SERIAL
let fotosSelecionadasEdicao = []; // para o modal de EDIÇÃO (Novas fotos a serem adicionadas)
let fotosExistentesEdicao = []; // para o modal de EDIÇÃO (Fotos já salvas no DB)
let timer = null;
let paginaAtual = 1;

/* ===========================
   BUSCA + PAGINAÇÃO AJAX
=========================== */

function debounceBuscar(valor) {
    clearTimeout(timer);
    timer = setTimeout(() => buscar(valor), 300);
}

function buscar(valor) {
    fetch(`/seriais/?q=${encodeURIComponent(valor)}&page=${paginaAtual}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
        .then(res => res.text())
        .then(html => {
            document.getElementById("tabela-seriais").innerHTML = html;
        });
}

function mudarPagina(pagina) {
    paginaAtual = pagina;
    buscar(document.getElementById("busca").value);
}

/* ===========================
   POPUP DETALHES (CORRIGIDO EXIBIÇÃO DA FOTO)
=========================== */

function abrirDetalhes(id) {
    fetch(`/seriais/detalhes/${id}/`)
        .then(res => res.json())
        .then(data => {
            let html = `
                <p><b>VCI:</b> ${data.numero_vci || '-'}</p>
                <p><b>Tablet:</b> ${data.numero_tablet || '-'}</p>
                <p><b>Prog:</b> ${data.numero_prog || '-'}</p>
                <p><b>Cliente:</b> ${data.cliente || '-'}</p>
                <p><b>Email:</b> ${data.email || '-'}</p>
                <p><b>Telefone:</b> ${data.telefone || '-'}</p>
                <p><b>Pedido:</b> ${data.pedido || '-'}</p>
                <p><b>Fotos:</b></p>
                <div style="display:flex;flex-wrap:wrap;">
            `;

            // CORREÇÃO: Usar a classe foto-miniatura
            data.fotos.forEach(url => {
                html += `<img src="${url}" class="foto-miniatura" alt="Foto do Serial">`;
            });

            html += `</div>`;
            
            // Botão para abrir o modal de edição
            html += `<button onclick="abrirModalEdicao(${data.id}); fecharPopup()" class="btn btn-primary" style="margin-top:20px;">Editar Serial</button>`;


            document.getElementById("conteudo-detalhes").innerHTML = html;
            document.getElementById("popup").style.display = "flex";
        });
}

function fecharPopup() {
    document.getElementById("popup").style.display = "none";
}


/* ===========================
   WEBSOCKET REALTIME (CORRIGIDO PROTOCOLO)
=========================== */
const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
const socket = new WebSocket(
    protocol + window.location.host + "/ws/seriais/"
);

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.mensagem === "atualizar_tabela") {
        buscar(document.getElementById("busca").value);
    }
};

/* ===========================
   CSRF Utility
=========================== */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

/* ===========================
   MODAL NOVO SERIAL (Ajustado)
=========================== */

function abrirModalNovo() {
    document.getElementById("modal-novo").style.display = "flex";
    document.getElementById("form-novo-serial").reset();
    fotosSelecionadasNovo = []; 
    atualizarPreviewNovo();
}

function fecharModalNovo() {
    document.getElementById("modal-novo").style.display = "none";
}

function salvarNovoSerial() {
    const form = document.getElementById("form-novo-serial");
    const formData = new FormData(form);

    fotosSelecionadasNovo.forEach(file => {
        formData.append("fotos", file);
    });

    fetch("/seriais/adicionar/", {
        method: "POST",
        body: formData 
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                fecharModalNovo();
                form.reset(); 
                fotosSelecionadasNovo = []; 
                atualizarPreviewNovo();
                buscar(document.getElementById("busca").value);
            } else {
                alert("Erro: " + JSON.stringify(data.errors));
            }
        });
}

/* ===========================
   PRÉ-VISUALIZAÇÃO DE FOTOS (NOVO SERIAL)
=========================== */

function handleAddImages(event) {
    const novosArquivos = Array.from(event.target.files);

    novosArquivos.forEach(file => {
        fotosSelecionadasNovo.push(file);
    });

    atualizarPreviewNovo();
}

function atualizarPreviewNovo() {
    const container = document.getElementById("preview-container");
    container.innerHTML = "";

    fotosSelecionadasNovo.forEach((file, index) => {
        const url = URL.createObjectURL(file);
        adicionarMiniatura(container, url, index, 'removerFotoNovo');
    });
}

function removerFotoNovo(index) {
    fotosSelecionadasNovo.splice(index, 1);
    atualizarPreviewNovo();
}


/* ===========================
   MODAL EDIÇÃO SERIAL (Implementação)
=========================== */

function abrirModalEdicao(id) {
    document.getElementById("modal-edicao").style.display = "flex";
    document.getElementById("form-edicao-serial").reset();
    fotosSelecionadasEdicao = []; 
    fotosExistentesEdicao = []; 
    document.getElementById("input-fotos-edicao").value = ''; // Limpa o input de arquivo

    fetch(`/seriais/detalhes/${id}/`)
        .then(res => res.json())
        .then(data => {
            // Preencher campos permitidos para edição
            document.getElementById("edicao-serial-id").value = data.id;
            document.getElementById("edicao-serial-id-text").textContent = `(${data.numero_vci})`;
            document.getElementById("edicao-numero_vci").value = data.numero_vci;
            document.getElementById("edicao-numero_tablet").value = data.numero_tablet || '';
            document.getElementById("edicao-numero_prog").value = data.numero_prog || '';

            // Carregar fotos existentes (usando o novo campo 'fotos_edicao')
            fotosExistentesEdicao = data.fotos_edicao || [];
            atualizarPreviewEdicao();
        });
}

function fecharModalEdicao() {
    document.getElementById("modal-edicao").style.display = "none";
}

function salvarEdicaoSerial() {
    const id = document.getElementById("edicao-serial-id").value;
    const form = document.getElementById("form-edicao-serial");
    const formData = new FormData(form);

    // Adicionar as novas fotos selecionadas para upload
    fotosSelecionadasEdicao.forEach(file => {
        formData.append("fotos", file);
    });

    fetch(`/seriais/editar/${id}/`, {
        method: "POST",
        body: formData 
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                fecharModalEdicao();
                buscar(document.getElementById("busca").value);
            } else {
                alert("Erro: " + JSON.stringify(data.errors));
            }
        });
}

function removerFotoExistente(index, fotoId) {
    const confirmacao = confirm("Tem certeza de que deseja remover esta foto? A remoção é permanente.");
    if (!confirmacao) return;

    const csrftoken = getCookie('csrftoken');
    fetch(`/seriais/remover_foto/${fotoId}/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken },
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Remove do array local para atualizar o preview
            fotosExistentesEdicao.splice(index, 1);
            atualizarPreviewEdicao();
        } else {
            alert("Erro ao remover foto do servidor: " + data.error);
        }
    })
    .catch(error => {
        alert("Erro na comunicação com o servidor.");
    });
}


/* ===========================
   PRÉ-VISUALIZAÇÃO DE FOTOS (EDIÇÃO SERIAL)
=========================== */

function handleAddImagesEdicao(event) {
    const novosArquivos = Array.from(event.target.files);

    novosArquivos.forEach(file => {
        fotosSelecionadasEdicao.push(file);
    });

    atualizarPreviewEdicao();
}

function removerFotoEdicao(index) {
    // Remove do array de novas fotos (antes do upload)
    fotosSelecionadasEdicao.splice(index, 1);
    atualizarPreviewEdicao();
}

function atualizarPreviewEdicao() {
    const containerExistente = document.getElementById("preview-edicao-existente-container");
    const containerNova = document.getElementById("preview-edicao-nova-container");
    
    if (!containerExistente || !containerNova) return;

    containerExistente.innerHTML = fotosExistentesEdicao.length > 0 ? '' : 'Nenhuma foto salva.';
    containerNova.innerHTML = '';

    // Renderizar fotos existentes (salvas no DB)
    fotosExistentesEdicao.forEach((foto, index) => {
        // Passa o ID da foto para a função de remoção
        adicionarMiniatura(containerExistente, foto.url, index, 'removerFotoExistente', foto.id);
    });

    // Renderizar novas fotos (a serem adicionadas)
    fotosSelecionadasEdicao.forEach((file, index) => {
        const url = URL.createObjectURL(file);
        adicionarMiniatura(containerNova, url, index, 'removerFotoEdicao');
    });
}

/* ===========================
   UTILITÁRIO DE MINIATURA (REAPROVEITÁVEL)
=========================== */

function adicionarMiniatura(container, url, index, funcaoRemocao, fotoId = null) {
    const div = document.createElement("div");
    div.style.position = "relative";
    div.style.width = "90px";
    div.style.height = "90px";
    
    let acaoRemocao = '';
    if (funcaoRemocao === 'removerFotoExistente' && fotoId !== null) {
        // Para fotos existentes, a função precisa do índice local E do ID do DB
        acaoRemocao = `${funcaoRemocao}(${index}, ${fotoId})`;
    } else {
        // Para novas fotos, a função precisa apenas do índice local
        acaoRemocao = `${funcaoRemocao}(${index})`;
    }

    div.innerHTML = `
        <img src="${url}" 
             style="width:100%;height:100%;object-fit:cover;border-radius:6px;" alt="Miniatura">

        <button type="button" 
                onclick="${acaoRemocao}"
                style="position:absolute;top:-6px;right:-6px;
                       background:#ff4444;color:white;border:none;
                       width:22px;height:22px;border-radius:50%;
                       cursor:pointer;font-size:12px;">
            ✕
        </button>
    `;

    container.appendChild(div);
}
</script>
{% load static %}

<style>
    body {
        font-family: Arial, sans-serif;
    }

    .btn {
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-dark {
        background: #333;
        color: white;
    }

    table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
    }

    th, td {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }

    th {
        background: #f9f9f9;
        text-align: left;
    }

    #popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: none;
        justify-content: center;
        align-items: center;
    }

    #popup-content {
        background: white;
        padding: 30px;
        width: 480px;
        border-radius: 10px;
        box-shadow: 0px 0px 20px rgba(0,0,0,0.2);
    }

    #busca {
        margin-left: 20px;
        padding: 10px 14px;
        width: 300px;
        border: 1px solid #ccc;
        border-radius: 6px;
    }

    tr:hover {
        background: #fafafa;
    }
</style>

<div style="padding: 25px;">

    <h1 style="font-size: 30px; margin-bottom: 20px;">
        Lista de Seriais Registrados
    </h1>

    <button onclick="abrirModalNovo()" class="btn btn-primary">
        + Adicionar Serial
    </button>

    <input type="text" id="busca" placeholder="Buscar..."
           onkeyup="debounceBuscar(this.value)">
</div>


<div id="tabela-seriais">
    {% include "serial_vci/_tabela.html" %}
</div>


<div id="popup" onclick="fecharPopup()">
    <div id="popup-content" onclick="event.stopPropagation()">
        <h2>Detalhes do Serial</h2>
        <div id="conteudo-detalhes"></div>

        <button onclick="fecharPopup()" class="btn btn-primary" style="margin-top:20px;">
            Fechar
        </button>
    </div>
</div>

<div id="modal-novo" onclick="fecharModalNovo()"
     style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:9999">

    <div onclick="event.stopPropagation()"
         style="background:white;padding:30px;width:520px;border-radius:12px;
                box-shadow:0px 4px 20px rgba(0,0,0,0.25);animation:fadeIn .2s ease;">

        <h2 style="margin-top:0;margin-bottom:20px;font-size:26px;">Novo Serial</h2>

        <form id="form-novo-serial" enctype="multipart/form-data">
            {% csrf_token %}

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">

                <div style="grid-column: span 2;">
                    <label>VCI</label>
                    <input name="numero_vci" class="input">
                </div>

                <div>
                    <label>Tablet</label>
                    <input name="numero_tablet" class="input">
                </div>

                <div>
                    <label>Prog</label>
                    <input name="numero_prog" class="input">
                </div>

                <div>
                    <label>Cliente</label>
                    <input name="cliente" class="input">
                </div>

                <div>
                    <label>Email</label>
                    <input name="email" type="email" class="input">
                </div>

                <div>
                    <label>Telefone</label>
                    <input name="telefone" class="input">
                </div>

                <div>
                    <label>Pedido</label>
                    <input name="pedido" class="input">
                </div>

                <div style="grid-column: span 2;">
                    <label>Fotos (múltiplas)</label>

                    <div id="preview-container" 
                        style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;"></div>

                    <input type="file" id="input-fotos" multiple accept="image/*"
                        style="display:none" onchange="handleAddImages(event)">

                    <button type="button" onclick="document.getElementById('input-fotos').click()"
                            class="btn btn-primary" style="margin-top:10px;">
                        + Adicionar fotos
                    </button>
                </div>

            </div>

            <div style="margin-top:25px;display:flex;justify-content:space-between;align-items:center;">
                <button type="button" onclick="fecharModalNovo()" class="btn btn-dark">Cancelar</button>
                <button type="button" onclick="salvarNovoSerial()" class="btn btn-primary">Salvar</button>
            </div>

        </form>
    </div>
</div>

<style>
    .input {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-top: 5px;
        font-size: 14px;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
</style>


<script>
/* =======================================
   VARIÁVEIS GLOBAIS (CORREÇÃO DE SCOPE/INITIALIZATION) 
   Corrigindo ReferenceError: Variável 'fotosSelecionadas'
   deve ser declarada antes de ser usada.
======================================= */
let fotosSelecionadas = []; // armazenar File objects
let timer = null;
let paginaAtual = 1;

/* ===========================
   BUSCA + PAGINAÇÃO AJAX
=========================== */

function debounceBuscar(valor) {
    clearTimeout(timer);
    timer = setTimeout(() => buscar(valor), 300);
}

function buscar(valor) {
    fetch(`/seriais/?q=${encodeURIComponent(valor)}&page=${paginaAtual}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
        .then(res => res.text())
        .then(html => {
            document.getElementById("tabela-seriais").innerHTML = html;
        });
}

function mudarPagina(pagina) {
    paginaAtual = pagina;
    buscar(document.getElementById("busca").value);
}

/* ===========================
   POPUP DETALHES
=========================== */

function abrirDetalhes(id) {
    fetch(`/seriais/detalhes/${id}/`)
        .then(res => res.json())
        .then(data => {
            let html = `
                <p><b>VCI:</b> ${data.numero_vci}</p>
                <p><b>Tablet:</b> ${data.numero_tablet}</p>
                <p><b>Prog:</b> ${data.numero_prog}</p>
                <p><b>Cliente:</b> ${data.cliente}</p>
                <p><b>Email:</b> ${data.email}</p>
                <p><b>Telefone:</b> ${data.telefone}</p>
                <p><b>Pedido:</b> ${data.pedido}</p>
                <p><b>Fotos:</b></p>
            `;

            data.fotos.forEach(url => {
                html += `<img src="${url}" style="width:80px;margin:5px;border-radius:4px;">`;
            });

            document.getElementById("conteudo-detalhes").innerHTML = html;
            document.getElementById("popup").style.display = "flex";
        });
}

function fecharPopup() {
    document.getElementById("popup").style.display = "none";
}


/* ===========================
   WEBSOCKET REALTIME (CORRIGIDO)
=========================== */
// CORREÇÃO: Usar o protocolo seguro (wss://) se a página for HTTPS, para evitar Mixed Content Error.
const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
const socket = new WebSocket(
    protocol + window.location.host + "/ws/seriais/"
);

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.mensagem === "atualizar_tabela") {
        buscar(document.getElementById("busca").value);
    }
};

/* ===========================
   MODAL NOVO SERIAL
=========================== */

function abrirModalNovo() {
    document.getElementById("modal-novo").style.display = "flex";
}

function fecharModalNovo() {
    document.getElementById("modal-novo").style.display = "none";
}

function salvarNovoSerial() {
    const form = document.getElementById("form-novo-serial");
    const formData = new FormData(form);

    // adicionar as fotos da nossa lista manual
    fotosSelecionadas.forEach(file => {
        formData.append("fotos", file);
    });

    fetch("/seriais/adicionar/", {
        method: "POST",
        body: formData 
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                fecharModalNovo();
                form.reset(); // ADIÇÃO: Limpar campos após sucesso
                fotosSelecionadas = []; // Resetar a lista de arquivos
                atualizarPreview();
                buscar(document.getElementById("busca").value);
            } else {
                 alert("Erro: " + JSON.stringify(data.errors));
            }
        });
}

/* Função utilitária para pegar o CSRF (mantida, caso precise em outro local) */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

/* ===========================
   PRÉ-VISUALIZAÇÃO DE FOTOS
=========================== */

function handleAddImages(event) {
    const novosArquivos = Array.from(event.target.files);

    novosArquivos.forEach(file => {
        fotosSelecionadas.push(file);
    });

    atualizarPreview();
}

function atualizarPreview() {
    const container = document.getElementById("preview-container");
    container.innerHTML = "";

    fotosSelecionadas.forEach((file, index) => {
        const url = URL.createObjectURL(file);

        const div = document.createElement("div");
        div.style.position = "relative";
        div.style.width = "90px";
        div.style.height = "90px";

        div.innerHTML = `
            <img src="${url}" 
                 style="width:100%;height:100%;object-fit:cover;border-radius:6px;">

            <button type="button" 
                    onclick="removerFoto(${index})"
                    style="position:absolute;top:-6px;right:-6px;
                           background:#ff4444;color:white;border:none;
                           width:22px;height:22px;border-radius:50%;
                           cursor:pointer;font-size:12px;">
                ✕
            </button>
        `;

        container.appendChild(div);
    });
}

function removerFoto(index) {
    fotosSelecionadas.splice(index, 1);
    atualizarPreview();
}


</script>
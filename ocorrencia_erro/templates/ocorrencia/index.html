{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="{% static 'ocorrencia/css/styles.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
    /* Estilos para o modal de imagem */
    #image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }

    #expanded-image {
        max-width: 90%;
        max-height: 90%;
        border-radius: 8px;
    }

    #close-modal {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        font-size: 18px;
    }

    #download-image {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }

    #download-image:hover {
        background: #218838;
    }

    /* Estilo para imagens clic√°veis no chat */
    .chat-message img {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        margin-top: 5px;
        border: 1px solid #ddd;
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .chat-message img:hover {
        transform: scale(1.05);
    }

    /* Restante do CSS permanece igual */
    .chat-image-button {
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 16px;
        margin-right: 8px;
    }

    .chat-image-button:hover {
        background-color: #218838;
    }

    .image-indicator {
        background-color: #007bff;
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 12px;
        margin-left: 8px;
    }
        /* Estilos para o sistema de notifica√ß√µes */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .clear-date-btn {
            margin-bottom:15px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 15px;
            cursor: pointer;
            z-index: 1000;
        }

        .clear-date-btn:hover {
            background: #c82333;
        }
        .today-date-btn {
            margin-bottom:15px;
            background: #569ff7;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 15px;
            cursor: pointer;
            z-index: 1000;
        }
        .headerFiles{
            display: flex;
            justify-content: space-between;
            align-items: center;    
        }
        .today-date-btn:hover {
            background: #4682ccff;
        }
        /* Estilos para o chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px; /* Altura fixa para o chat */
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            padding: 10px;
            margin-top: 20px;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column; /* Para que as mensagens novas apare√ßam na parte inferior */
        }

        .chat-message {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.my-message {
            background-color: #0459B5;
            color: white;
            align-self: flex-end; /* Alinha a sua mensagem √† direita */
        }

        .chat-message.other-message {
            background-color: #e5e5e5;
            color: #333;
            align-self: flex-start; /* Alinha a mensagem do outro √† esquerda */
        }

        .chat-message-author {
            font-size: 10px;
            color: #999;
            margin-bottom: 2px;
        }

        .chat-input-area {
            display: flex;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .chat-input-area input {
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 20px;
            padding: 8px 15px;
            margin-right: 8px;
        }

        .chat-input-area button {
            background-color: #0459B5;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chat-input-area button:hover {
            background-color: #0347a0;
        }
        .chat-message-time {
            display: block; /* Garante que a hora fique em uma nova linha */
            font-size: 10px;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }

        .chat-message.my-message .chat-message-time {
            color: rgba(255, 255, 255, 0.7); /* Cor da hora para suas mensagens */
        }
        .notification-bell {
            position: relative;
            background: #0459B5;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .notification-bell:hover {
            background: #0347a0;
            transform: scale(1.05);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
        }
        
        .notification-dropdown {
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        .notification-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            color: #333;
        }
        
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .notification-item:hover {
            background-color: #f8f9fa;
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        .notification-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .notification-summary {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .notification-time {
            color: #999;
            font-size: 12px;
        }
        
        .no-notifications {
            padding: 20px;
            text-align: center;
            color: #999;
            font-style: italic;
        }
        .notification-summary button {
            background-color: #0459B5; /* azul igual ao sino */
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .notification-summary button:hover {
            background-color: #0347a0; /* azul mais escuro no hover */
            transform: scale(1.05);
        }

        .notification-summary button:active {
            background-color: #02367d;
            transform: scale(0.98);
        }
        .containerFooterPopup{
            display: flex;
            align-items: center;    
            justify-content: space-around;
        }
    </style>
</head>
<body>
    <span id="username-holder" data-username="{{ request.user.username }}"></span>
    <!-- Container de notifica√ß√µes -->
    <div class="notification-container">
        <button class="notification-bell" id="notification-bell" onclick="toggleNotifications()">
            üîî
            <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
        </button>
        
        <div class="notification-dropdown" id="notification-dropdown">
            <div class="notification-header">
                Notifica√ß√µes
            </div>
            <div id="notification-list">
                <div class="no-notifications">
                    Nenhuma notifica√ß√£o
                </div>
            </div>
        </div>
    </div>

    <table id="data-table" class="table">
        <thead>
            <tr style="background-color: #0459B5;">
                {% include 'ocorrencia/components/lineHead.html' with name='id' ID="codigo_externo"%}
                {% include 'ocorrencia/components/lineHead.html' with name='data' ID="data"%}
                {% include 'ocorrencia/components/lineHead.html' with name='T√©cnico' ID="technical"%}
                {% include 'ocorrencia/components/lineHead.html' with name='pa√≠s' ID="country"%}
                {% include 'ocorrencia/components/lineHead.html' with name='dispositivo' ID="device"%}
                {% include 'ocorrencia/components/lineHead.html' with name='area' ID="area"%}
                {% include 'ocorrencia/components/lineHead.html' with name='marca' ID="brand"%}
                {% include 'ocorrencia/components/lineHead.html' with name='modelo' ID="model"%}
                {% include 'ocorrencia/components/lineHead.html' with name='Detalhes' ID="problem_detected" checbox='false'%}
                {% include 'ocorrencia/components/lineHead.html' with name='status' ID="status"%}
                {% include 'ocorrencia/components/lineHead.html' with name='prazo' ID="deadline"%}
                {% if has_edit_permission%}
                    {% include 'ocorrencia/components/lineHead.html' with name='respons√°vel' ID="responsible"%}
                {%endif%}
                {% include 'ocorrencia/components/lineHead.html' with name='finalizado' ID="finished"%}
            </tr>
            
        </thead>
        <tbody id="table-body" translate="no">
        {# O corpo da tabela ser√° preenchido via AJAX #}
        </tbody>
    </table>
    
    <div id="paginate">
        <span class="button-paginator" id="last">Voltar</span>
        <span id="num_pages">
            
        </span>
        <span class="button-paginator" id="next">Avan√ßar</span>
    </div>
    <a href="{% url 'subir_ocorrencia' %}" style="padding: 0.6rem 1.2rem;
        font-size: 1rem;
        border: none;
        border-radius: 0.3rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        text-decoration: none;
        display: inline-block;
        background-color: #157347;
        color: var(--light);">
        <i class="fas fa-plus"></i> Nova Ocorr√™ncia
    </a>
    {%if has_full_permission%}
        <a href="{% url 'criar_usuario' %}" style="padding: 0.6rem 1.2rem;
        font-size: 1rem;
        border: none;
        border-radius: 0.3rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        text-decoration: none;
        display: inline-block;
        background-color:rgb(17, 90, 226);
        color: var(--light);">
            <i class="fas fa-plus"></i> Criar novo respons√°vel
        </a>
    {%endif%}
    {%if has_full_permission%}
    <footer>
        <div id="ocorrencias-panel">
            <label for="responsavel-select">Selecionar respons√°vel:</label>
            <div id="selector-and-info">
                <select id="responsavel-select">
                    <option value="">-- Escolha --</option>
                </select>

                <div id="ocorrencias-info" style="display: none;">
                    <strong>Total de ocorr√™ncias: <span id="total-ocorrencias">0</span></strong>
                    <ul id="status-percentuais"></ul>
                </div>
            </div>
        </div>
    </footer>
    {%endif%}
<script>
    function getCookie(name) { 
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    return decodeURIComponent(cookie.substring(name.length + 1));
                }
            }
        }
        return null;
    }
    if("{{has_full_permission}}" == "True"){
        const ocorrenciasData = {{ ocorrencias_json | safe }};
        
        const select = document.getElementById('responsavel-select');
        const infoDiv = document.getElementById('ocorrencias-info');
        const totalSpan = document.getElementById('total-ocorrencias');
        const statusList = document.getElementById('status-percentuais');
        
        // Preenche <select> com nomes dos respons√°veis
        Object.keys(ocorrenciasData).forEach(nome => {
          const opt = document.createElement('option');
          opt.value = nome;
          opt.textContent = nome;
          select.appendChild(opt);
        });
        
        select.addEventListener('change', () => {
          const responsavel = select.value;
        
          if (!responsavel || !ocorrenciasData[responsavel]) {
            infoDiv.style.display = 'none';
            return;
          }
        
          const stats = ocorrenciasData[responsavel];
          const total = Object.values(stats).reduce((a, b) => a + b, 0);
        
          totalSpan.textContent = total;
          statusList.innerHTML = '';
        
          Object.entries(stats).forEach(([status, qtd]) => {
            const percent = total > 0 ? ((qtd / total) * 100).toFixed(1) : 0;
            const li = document.createElement('li');
            li.textContent = `${status}: ${qtd} (${percent}%)`;
        
            statusList.appendChild(li);
          });
        
          infoDiv.style.display = 'block';
        });
    }
    function deleteFile(fileId, fileName, record) {
        if (confirm(`Deseja realmente deletar o arquivo "${fileName}"?`)) {
            const formData = new FormData();
            formData.append('action', 'deletar');
            formData.append('file', fileId);

            fetch('{% url "update_ocorrencia" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')  // importante para Django
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    applyFiltersAndSort();
                    Swal.close();
                    setTimeout(async () => {
                    try {
                        console.log(record)
                        const response = await fetch(`/ocorrencia/get_record/${record.id}`);
                        const updatedRecord = await response.json();
                        showProblemDetails(updatedRecord);
                    } catch (error) {
                        console.error("Erro ao buscar o registro atualizado:", error);
                        alert("Erro ao atualizar os dados da ocorr√™ncia.");
                    }
                    }, 100);


                } else {
                    alert('Erro ao deletar o arquivo: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao deletar o arquivo.');
            });
        }
    }
    window.deleteFile = deleteFile;

    function downloadFile(url, filename) {
        try {
            // Se a URL j√° √© uma URL completa de download, usa diretamente
            window.open(`/download_arquivo/${url}`, '_blank');
                if (url) {
                    null
                } else {
                    // Cria um elemento 'a' tempor√°rio para for√ßar o download
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename || 'arquivo';
                    link.target = '_blank';
                    
                    // Adiciona o link ao DOM temporariamente
                    document.body.appendChild(link);
                    
                    // Simula o clique no link
                    link.click();
                    
                    // Remove o link do DOM
                    document.body.removeChild(link);
                }
                
                // Feedback visual opcional
                //console.log(`Download iniciado: ${filename}`);
            } catch (error) {
                console.error('Erro ao fazer download:', error);
                alert('Erro ao fazer download do arquivo. Tente novamente.');
            }
        }
    function capitalizeFirstLetter(str) {
        str = str.toLowerCase()
        if (typeof str !== 'string' || str.length === 0) {
            return str; // Return as-is if not a string or empty
        }
        return str.charAt(0).toUpperCase() + str.slice(1);
    }
    const responsaveisPorPais = JSON.parse('{{ responsaveis_por_pais|escapejs }}');
    const todosResponsaveis = {{ todos_responsaveis|safe }};
    const paisesPorResponsavel = {};
    Object.keys(responsaveisPorPais).forEach(paisId => {
        responsaveisPorPais[paisId].forEach(responsavel => {
        if (!paisesPorResponsavel[responsavel.name]) {
            paisesPorResponsavel[responsavel.name] = [];
        }
        paisesPorResponsavel[responsavel.name].push(parseInt(paisId));
        });
    });
    // ===== SISTEMA DE ATUALIZA√á√ÉO DIN√ÇMICA DE STATUS (ESCOPO GLOBAL) =====
    // Estado global para controlar atualiza√ß√µes
    let statusUpdateSystem = {
        records: [],
        isInitialized: false,
        observers: new Map(),
        debounceTimers: new Map()
    };

    // ===== SISTEMA DE OBSERVERS PARA FUNCIONALIDADES CHINA (ESCOPO GLOBAL) =====
    let chinaStatusObserver = {
        records: new Map(),
        timers: new Map(),
        
        // Observa mudan√ßas no status China
        observe(recordId, record) {
            this.records.set(recordId, record);
            this.scheduleUpdate(recordId, record);
        },
        
        // Remove observa√ß√£o
        unobserve(recordId) {
            if (this.timers.has(recordId)) {
                clearTimeout(this.timers.get(recordId));
                this.timers.delete(recordId);
            }
            this.records.delete(recordId);
        },
        
        // Agenda atualiza√ß√£o com debounce
        scheduleUpdate(recordId, record, delay = 1000) {
            if (this.timers.has(recordId)) {
                clearTimeout(this.timers.get(recordId));
            }
            
            const timer = setTimeout(() => {
                //this.updateChinaStatus(recordId, record);
                this.timers.delete(recordId);
            }, delay);
            
            this.timers.set(recordId, timer);
        },
        
        
        
        // Limpa todos os observers
        clear() {
            this.timers.forEach(timer => clearTimeout(timer));
            this.timers.clear();
            this.records.clear();
        }
    };

    // Fun√ß√£o para calcular status espec√≠fico da China (ESCOPO GLOBAL)
    function calculateChinaStatus(record) {
        const currentStatus = record.status;
        
        // Se n√£o √© status relacionado √† China, retorna null
        if (currentStatus !== 'Aguardando China' && currentStatus !== 'China Atrasada') {
            return null;
        }
        
        const parseDate = (dateStr) => {
            if (!dateStr || dateStr === "N√£o definido" || dateStr === "N√£o finalizado") return null;
            const [day, month, year] = dateStr.split('/').map(Number);
            return new Date(year, month - 1, day);
        };
        
        const deadlineDate = parseDate(record.deadline);
        if (!deadlineDate) return currentStatus;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const deadline = new Date(deadlineDate);
        deadline.setHours(0, 0, 0, 0);
        
        // Se j√° est√° finalizado, n√£o muda o status China
        if (record.finished && record.finished !== "N√£o finalizado") {
            return currentStatus;
        }
        
        // L√≥gica de transi√ß√£o: se passou do prazo e est√° "Aguardando China", vira "China Atrasada"
        if (currentStatus === 'Aguardando China' && today > deadline) {
            return 'China Atrasada';
        }
        
        // Se est√° "China Atrasada" mas n√£o passou do prazo, volta para "Aguardando China"
        if (currentStatus === 'China Atrasada' && today <= deadline) {
            return 'Aguardando China';
        }
        
        return currentStatus;
    }

    document.addEventListener("DOMContentLoaded", function ( ) {
        "use strict";

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }
        // Montar lista de arquivos em HTML
        
        // Fun√ß√£o para mostrar pop-up com detalhes do problema
        function showProblemDetails(record) {
            fetch(`/ocorrencia/notificacoes/record/${record.id}/marcar_lidas/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.count > 0) {
                    // Atualizar o contador de notifica√ß√µes
                    atualizarContadorNotificacoes();
                }
            })
            .catch(error => {
                console.error('Erro ao marcar notifica√ß√µes como lidas:', error);
            });
            const arquivosListHTML = (record.arquivos && record.arquivos.length > 0)
            ? `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
                ${record.arquivos.map(arq => `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 8px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">üìé</span>
                            <span style="font-weight: 500; color: #495057;">${arq.nome_original || 'Arquivo'}</span>
                        </div>
                        <span>
                        <button onclick="deleteFile('${arq.id}', '${arq.nome_original}', ${JSON.stringify(record).replace(/"/g, '&quot;')})"
                                style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; transition: background-color 0.2s;">
                            üóë Deletar
                        </button>
                        <button onclick="downloadFile('${arq.id}', '${arq.nome_original || 'arquivo'}')" 
                                style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; transition: background-color 0.2s;">
                            ‚¨á Download
                        </button>
                        </span>
                    </div>
                `).join('')}
                </div>`
            : '<p style="color: #6c757d; font-style: italic;">Nenhum arquivo anexado.</p>';
            // Assegura que os valores sejam strings vazias se forem null/undefined
            const problemDetectedValue = record.problem_detected || '';
            const feedbackTechnicalValue = record.feedback_technical || '';
            const feedbackManagerValue = record.feedback_manager || '';

            // Gera um ID √∫nico para cada textarea para evitar conflitos
            const problemDetectedId = `problem_detected_${record.id}`;
            const feedbackTechnicalId = `feedback_technical_${record.id}`;
            const feedbackManagerId = `feedback_manager_${record.id}`;
            
            // Cria o conte√∫do HTML do pop-up com informa√ß√µes detalhadas e textareas edit√°veis
            const popupContent = `
                <div style="text-align: left;">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">Detalhes da Ocorr√™ncia</h3>
                    
                    <div style="background: var(--gray); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0; color: var(--text);">Problema Detectado:</h4>
                        <textarea id="${problemDetectedId}" 
                                  data-record-id="${record.id}" 
                                  data-field-name="problem_detected" 
                                  data-initial-value="${problemDetectedValue}"
                                  style="width: 100%; min-height: 100px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; resize: vertical; font-family: inherit;">${problemDetectedValue}</textarea>
                        <button id="button_pdf" class="btn btn-primary" style="padding: 8px 15px; font-size: 0.9rem;">
                           Gerar PDF
                        </button>

                        <button id="button_copy" class="btn btn-primary" style="padding: 8px 15px; font-size: 0.9rem;">
                           COPIAR INFORMA√á√ïES
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <strong>ID:</strong><br>
                            <span style="color: var(--text-light);" translate="no">
                            ${record.codigo_externo || 'N√£o informado'}
                            
                            </span>
                        </div>
                        <div>
                            <strong>T√©cnico:</strong><br>
                            <span style="color: var(--text-light);" translate="no">${record.technical || 'N√£o informado'}</span>
                        </div>
                        <div>
                            <strong>Pa√≠s:</strong><br>
                            <span style="color: var(--text-light);" translate="no">${record.country || 'N√£o informado'}</span>
                        </div>
                        {%if has_full_permission %}
                        <div>
                            <strong>Telefone de contato:</strong><br>
                            <span style="color: var(--text-light);" translate="no">${record.contact || 'N√£o informado'}</span>
                        </div>
                        {%endif%}
                        <div>
                            <strong>Dispositivo:</strong><br>
                            <span style="color: var(--text-light);" translate="no">${record.device || 'N√£o informado'}</span>
                        </div>
                        <div>
                            <strong>√Årea:</strong><br>
                            <span style="color: var(--text-light);" translate="no">${record.area || 'N√£o informado'}</span>
                        </div>
                        <div>
                            <strong>Serial:</strong><br>
                            <span style="color: var(--text-light);" translate="no">${record.serial || 'N√£o informado'}</span>
                        </div>
                        <div>
                            <strong>Marca:</strong><br>
                            <span style="color: var(--text-light);" translate="no">${record.brand || 'N√£o informado'}</span>
                        </div>
                        <div>
                            <strong>Modelo:</strong><br>
                            <span style="color: var(--text-light);" translate="no">${record.model || 'N√£o informado'}</span>
                        </div>
                        <div>
                            <strong>Ano:</strong><br>
                            <span style="color: var(--text-light);" translate="no">${record.year || 'N√£o informado'}</span>
                        </div>
                        <div>
                            <strong>Vers√£o:</strong><br>
                            <span style="color: var(--text-light);" translate="no">${record.version || 'N√£o informado'}</span>
                        </div>
                        <div>
                            <strong>Status:</strong><br>

                                <select class="editable-select-status" data-record-id="${record.id}" data-field-name="status">
                                    <option value="REQUESTED" ${record.status_code === 'REQUESTED' ? 'selected' : ''}>Aguardando Respons√°vel</option>
                                    <option value="AWAITING_CHINA" ${record.status_code === 'AWAITING_CHINA' || record.status_code === 'AWAITING_CHINA_LATE' ? 'selected' : ''}>Aguardando China</option>
                                </select>
                        </div>
                        <div>
                            <strong>Respons√°vel:</strong><br>
                            <span style="color: var(--text-light);" translate="no">${record.responsible || 'N√£o informado'}</span>
                        </div>
                        <div>
                            <strong>Data:</strong><br>
                            <span style="color: var(--text-light);" translate="no">${record.data ? formatDateToDisplay(record.data) : 'N√£o informado'}</span>
                        </div>
                        {% if has_edit_permission %}
                            <div>
                                <strong>Prazo:</strong><br>
                                <input type="text"
                                    class="date-input flatpickr"
                                    data-record-id="${record.id}"
                                    data-field-name="deadline"
                                    value="${record.deadline ? formatDateToDisplay(record.deadline) : ''}"
                                    placeholder="dd/mm/aaaa" />
                            </div>
                            
                            {% else %}
                            <div>
                                <strong>Prazo:</strong><br>
                                <span style="color: var(--text-light);" translate="no">
                                    ${record.deadline ? formatDateToDisplay(record.deadline) : 'N√£o definido'}
                                </span>
                            </div>
                        {% endif %}
                        <div>
                            <strong>Finalizado:</strong><br>
                            <input type="text"
                                class="date-input flatpickr"
                                data-record-id="${record.id}"
                                data-field-name="finished"
                                value="${record.finished ? formatDateToDisplay(record.finished) : ''}"
                                placeholder="dd/mm/aaaa" />
                        </div>
                    </div>
                    <h5 style="margin-top: 20px; margin-bottom: 10px; color: var(--secondary);">Adicionar novo arquivo:</h5>
                        <div id="file-upload-wrapper-${record.id}" class="file-upload-wrapper full-width">
                            <div id="file-preview-container" class="file-preview-container"></div>

                            

                            <form method="POST" enctype="multipart/form-data" id="form-ocorrencia" class="file-upload">

                                {% csrf_token %}
                                
                                <input type="hidden" name="record" value="${record.id}"/>
                                <input type="hidden" name="page_num" value="${page_num}"/>
                                
                                <span class="container_buttons_popup">
                                    <label for="arquivo" class="custom-file-button">Selecionar Arquivos</label>
                                    <input type="file" id="arquivo" name="arquivo" multiple />
                                    <input type="submit" value="Cadastrar" required />
                                    <button type="button" id="clear-all-files-btn" class="clear-all-files-btn" style="display: none;">
                                        Limpar Tudo
                                    </button>
                                </span>
                            </form>
                        </div>
                    <div class="chat-container" translate="no">
                    <h4 style="margin-left: 10px; margin-top: 10px; color: var(--primary);">Chat de feedback</h4>
                    <div id="logged-in-user-id" style="display:none;">{{ request.user.id }}</div>
                    <div id="logged-in-username" style="display:none;">{{ request.user.username }}</div>
                    <div id="chat-messages" class="chat-messages"></div>
                    <form id="${record.id}-chat">
                        <div class="chat-input-area">
                            <input type="text" id="chat-message-input" placeholder="Digite sua mensagem...">
                            
                            <!-- Bot√£o para upload de imagem -->
                            <label for="chat-image-input-${record.id}" class="chat-image-button" title="Enviar imagem">
                                üì∑
                            </label>
                            <input type="file" id="chat-image-input-${record.id}" accept="image/*" style="display: none;">
                            
                            <button id="chat-send-button">Enviar</button>
                        </div>
                    </form>
                </div>
                    <div style="margin-bottom: 20px;" translate="no">
                        <div class="headerFiles">
                            <h4>Arquivos anexados:</h4>
                            ${record.arquivos.length > 0 ? `
                                <button id="allDownload"style="background: #007bff; color: white; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                    Baixar Todos
                                </button>
                            ` : ''}
                        </div>
                        ${arquivosListHTML}
                        
                    </div>
                    
                </div>
            `;
            
            let id = record.id
            Swal.fire({
                title: 'Informa√ß√µes Detalhadas',
                html: popupContent,
                width: '80%',
                maxWidth: '800px',
                showCloseButton: true,
                showConfirmButton: true,
                confirmButtonText: 'Fechar',
                confirmButtonColor: '#0056b3',
                customClass: {
                    popup: 'problem-details-popup',
                    content: 'problem-details-content'
                },
                didOpen: () => {
                    try{
                        const allDownload = document.getElementById("allDownload")
                        allDownload.addEventListener('click', ()=>{
                            window.open(`/ocorrencia/download_todos/${id}/`, '_blank');
                        })
                    }
                    catch(e){
                        //
                    }

                    // Adiciona event listeners para os textareas ap√≥s o SweetAlert ser aberto
                    const problemDetectedTextarea = document.getElementById(problemDetectedId);
                    const feedbackTechnicalTextarea = document.getElementById(feedbackTechnicalId);
                    const feedbackManagerTextarea = document.getElementById(feedbackManagerId);
                    document.getElementById("button_pdf").addEventListener('click', ()=>{
                        handleGerarPdf(id, record.codigo_externo)
                    })
                    document.getElementById("button_copy").style.display = window.location.protocol === 'https:' ? '' : 'none'
                    document.getElementById("button_copy").addEventListener("click", () => {
                        const idStr = String(record.id);
                        const codigoStr = String(record.codigo_externo || "");

                        const infos = [
                            `ID: ${idStr}`,
                            codigoStr && codigoStr !== idStr ? `Token: ${codigoStr}` : null,
                            `T√©cnico: ${record.technical || 'N√£o informado'}`,
                            `Dispositivo: ${record.device || 'N√£o informado'}`,
                            `√Årea: ${record.area || 'N√£o informado'}`,
                            `Serial: ${record.serial || 'N√£o informado'}`,
                            `Marca: ${record.brand || 'N√£o informado'}`,
                            `Modelo: ${record.model || 'N√£o informado'}`,
                            `Ano: ${record.year || 'N√£o informado'}`,
                            `Data: ${record.data ? formatDateToDisplay(record.data) : 'N√£o informado'}`,
                            `Problema Detectado: ${problemDetectedValue}`
                        ].filter(Boolean);

                        const textoFinal = infos.join('\n');

                        navigator.clipboard.writeText(textoFinal)
                        .then(() => showSwalStyledToast("Informa√ß√µes copiadas com sucesso!", "success"))
                        .catch(() => showSwalStyledToast("Erro ao copiar informa√ß√µes!", "error"));

                    });

                    // fun√ß√£o auxiliar para exibir o toast personalizado
                    function showSwalStyledToast(message, type = "success") {
                        const toast = document.createElement("div");
                        toast.className = `custom-swal-toast swal2-popup swal2-toast swal2-icon-${type}`;
                        toast.innerHTML = `
                            <div class="swal2-icon swal2-${type} swal2-icon-show">
                                ${type === "success"
                                    ? '<div class="swal2-success-circular-line-left"></div><span class="swal2-success-line-tip"></span><span class="swal2-success-line-long"></span><div class="swal2-success-ring"></div><div class="swal2-success-fix"></div><div class="swal2-success-circular-line-right"></div>'
                                    : '<span class="swal2-x-mark"><span class="swal2-x-mark-line-left"></span><span class="swal2-x-mark-line-right"></span></span>'
                                }
                            </div>
                            <div class="custom-swal-toast-text">${message}</div>
                        `;

                        document.body.appendChild(toast);

                        // Anima√ß√£o de entrada
                        setTimeout(() => toast.classList.add("show"), 10);

                        // Remove depois de 2,5s
                        setTimeout(() => {
                            toast.classList.remove("show");
                            setTimeout(() => toast.remove(), 300);
                        }, 2500);
                    }


                    document.getElementById('form-ocorrencia').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        const data = new FormData(form);
                        try {
                            const response = await fetch('{% url "update_ocorrencia" %}', {
                                method: "POST",
                                headers: {
                                    'X-CSRFToken': data.get('csrfmiddlewaretoken')
                                },
                                body: data
                            });

                            if (!response.ok) {
                                throw new Error('Erro de rede ou do servidor');
                            }

                            const result = await response.json();

                            if (result.status === "success") {
                                await applyFiltersAndSort(); // Garante que os dados da tabela e arquivos sejam atualizados
                                Swal.close(); // Fecha o popup
                                setTimeout(async () => {
                                try {
                                    const response = await fetch(`/ocorrencia/get_record/${id}`);
                                    const updatedRecord = await response.json();
                                    showProblemDetails(updatedRecord);
                                } catch (error) {
                                    console.error("Erro ao buscar o registro atualizado:", error);
                                    alert("Erro ao atualizar os dados da ocorr√™ncia.");
                                }
                                }, 100);


                                
                            } else {
                                alert("Erro: " + result.message);
                            }
                        } catch (error) {
                            alert("Erro inesperado: " + error.message);
                        }
                    })
                    if (problemDetectedTextarea) {
                        problemDetectedTextarea.addEventListener('input', (e) => {
                            atualizarDadosPopup(e.target);
                        });
                    }
                    if (feedbackTechnicalTextarea) {
                        feedbackTechnicalTextarea.addEventListener('input', (e) => {
                            atualizarDadosPopup(e.target);
                        });
                    }
                    if (feedbackManagerTextarea) {
                        feedbackManagerTextarea.addEventListener('input', (e) => {
                            atualizarDadosPopup(e.target);
                        });
                    }
                    // --- IN√çCIO DA L√ìGICA DE UPLOAD COM PR√â-VISUALIZA√á√ÉO ---

                    const uploadWrapper = document.getElementById(`file-upload-wrapper-${record.id}`);
                    const fileInput = document.getElementById('arquivo');
                    const previewContainer = document.getElementById('file-preview-container');
                    const clearAllBtn = document.getElementById('clear-all-files-btn'); // 1. SELECIONE O BOT√ÉO

                    let fileStore = new DataTransfer();

                    // Fun√ß√£o para renderizar os cards de pr√©-visualiza√ß√£o
                    const renderPreviews = () => {
                        previewContainer.innerHTML = ''; 
                        
                        Array.from(fileStore.files).forEach((file, index) => {
                            // ... (c√≥digo de cria√ß√£o do card - sem altera√ß√µes)
                            const card = document.createElement('div');
                            card.className = 'file-preview-card';
                            card.innerHTML = `
                                <span class="file-name" title="${file.name}">${file.name}</span>
                                <button type="button" class="remove-file-btn" data-index="${index}">&times;</button>
                            `;
                            previewContainer.appendChild(card);
                        });

                        // 2. MOSTRA/ESCONDE O BOT√ÉO "LIMPAR TUDO"
                        if (fileStore.files.length > 0) {
                            clearAllBtn.style.display = 'block';
                        } else {
                            clearAllBtn.style.display = 'none';
                        }

                        fileInput.files = fileStore.files;
                    };

                    // ... (fun√ß√£o handleFiles - sem altera√ß√µes) ...
                    const handleFiles = (files) => {
                        for (const file of files) {
                            fileStore.items.add(file);
                        }
                        renderPreviews();
                    };

                    // ... (event listener do previewContainer - sem altera√ß√µes) ...
                    previewContainer.addEventListener('click', (e) => {
                        if (e.target.classList.contains('remove-file-btn')) {
                            const indexToRemove = parseInt(e.target.dataset.index, 10);
                            const newFiles = new DataTransfer();
                            Array.from(fileStore.files).forEach((file, index) => {
                                if (index !== indexToRemove) {
                                    newFiles.items.add(file);
                                }
                            });
                            fileStore = newFiles;
                            renderPreviews();
                        }
                    });

                    // 3. ADICIONE O EVENT LISTENER PARA O BOT√ÉO "LIMPAR TUDO"
                    clearAllBtn.addEventListener('click', () => {
                        fileStore = new DataTransfer(); // Esvazia nossa lista de arquivos
                        renderPreviews(); // Renderiza novamente a UI (que ficar√° vazia)
                    });

                    // ... (L√≥gica de Drag and Drop e clique no input - sem altera√ß√µes) ...
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        uploadWrapper.addEventListener(eventName, (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                        }, false);
                    });
                    ['dragenter', 'dragover'].forEach(eventName => {
                        uploadWrapper.addEventListener(eventName, () => uploadWrapper.classList.add('drag-over'), false);
                    });
                    ['dragleave', 'drop'].forEach(eventName => {
                        uploadWrapper.addEventListener(eventName, () => uploadWrapper.classList.remove('drag-over'), false);
                    });
                    uploadWrapper.addEventListener('drop', (e) => {
                        handleFiles(e.dataTransfer.files);
                    }, false);
                    fileInput.addEventListener('change', () => {
                        handleFiles(fileInput.files);
                    });
                    // No seu arquivo index.html, dentro da tag <script>
                    const recordId = JSON.parse(id);
                    const chatBox = document.getElementById('chat-box');
                    const form = document.getElementById(`${id}-chat`);
                    const chatInput = document.getElementById('chat-message-input');
                    const chatMessages = document.getElementById('chat-messages');

                    const loggedInUsername = document.getElementById('logged-in-username').textContent

                    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';

                    const chatSocket = new WebSocket(
                        protocol +
                        window.location.host +
                        '/ws/chat/' +
                        recordId +
                        '/'
                    );

                    chatSocket.onclose = function(e) {
                        console.error('O socket do chat foi fechado inesperadamente');
                    };
                    const imageInput = document.getElementById(`chat-image-input-${id}`);
                    let selectedImageBase64 = null;

                    // Adicionar suporte para drag and drop no input do chat
                    chatInput.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        this.style.backgroundColor = '#f0f8ff';
                    });

                    chatInput.addEventListener('dragleave', function(e) {
                        e.preventDefault();
                        this.style.backgroundColor = '';
                    });

                    chatInput.addEventListener('drop', function(e) {
                        e.preventDefault();
                        this.style.backgroundColor = '';
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            handleImageSelection(files[0]);
                        }
                    });

                    // Sistema de modal para expandir imagens
                    function setupImageModal() {
                    const modal = document.getElementById('image-modal');
                    const expandedImg = document.getElementById('expanded-image');
                    const closeBtn = document.getElementById('close-modal');
                    const downloadBtn = document.getElementById('download-image');
                    
                    let currentImageBase64 = '';
                    let currentImageName = 'imagem_chat.png';
                    
                    // Fechar modal ao clicar no X
                    closeBtn.addEventListener('click', function() {
                        modal.style.display = 'none';
                    });
                    
                    // Fechar modal ao clicar fora da imagem
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                    
                    // Fechar modal com ESC
                    document.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape' && modal.style.display === 'flex') {
                            modal.style.display = 'none';
                        }
                    });
                    
                    // Fun√ß√£o para download da imagem
                    function downloadImage() {
                        if (!currentImageBase64) return;
                        
                        // Cria um link tempor√°rio para download
                        const link = document.createElement('a');
                        link.href = currentImageBase64;
                        link.download = currentImageName;
                        
                        // Adiciona ao DOM, clica e remove
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // Feedback visual
                        const originalText = downloadBtn.textContent;
                        downloadBtn.textContent = '‚úÖ Baixado!';
                        downloadBtn.style.background = '#17a2b8';
                        
                        setTimeout(() => {
                            downloadBtn.textContent = originalText;
                            downloadBtn.style.background = '#28a745';
                        }, 2000);
                    }
                    
                    // Event listener para o bot√£o de download
                    downloadBtn.addEventListener('click', downloadImage);
                    
                    // Fun√ß√£o para expandir imagem (agora tamb√©m armazena dados para download)
                    function expandImage(base64Data, imageName = 'imagem_chat.png') {
                        currentImageBase64 = base64Data;
                        currentImageName = imageName;
                        expandedImg.src = base64Data;
                        modal.style.display = 'flex';
                        
                        // Foca no modal para funcionar o ESC
                        modal.focus();
                    }
                    
                    return { modal, expandedImg, expandImage, downloadImage };
                }

                // Inicializar modal
                const { modal, expandedImg, expandImage } = setupImageModal();

                // Event listener para sele√ß√£o de imagem via bot√£o
                imageInput.addEventListener('change', function(e) {
                    handleImageSelection(e.target.files[0]);
                });

                // Fun√ß√£o para lidar com sele√ß√£o de imagem (reutiliz√°vel)
                function handleImageSelection(file) {
                    if (file) {
                        // Verifica se √© uma imagem
                        if (!file.type.startsWith('image/')) {
                            alert('Por favor, selecione apenas arquivos de imagem.');
                            return;
                        }
                        
                        // Verifica o tamanho do arquivo (limite de 2MB para Base64)
                        if (file.size > 10 * 1024 * 1024) {
                            alert('A imagem deve ter no m√°ximo 2MB.');
                            return;
                        }
                        
                        // Converte a imagem para Base64
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            selectedImageBase64 = e.target.result;
                            
                            // Mostra indicador visual que uma imagem foi selecionada
                            const imageButton = document.querySelector(`label[for="chat-image-input-${id}"]`);
                            if (!imageButton.querySelector('.image-indicator')) {
                                const indicator = document.createElement('span');
                                indicator.className = 'image-indicator';
                                indicator.textContent = '1';
                                imageButton.appendChild(indicator);
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                }

                    // Fun√ß√£o para lidar com Ctrl+V
                    function handlePaste(event) {
                    // Verifica se Ctrl+V foi pressionado e se o foco est√° no input do chat
                    if ((event.ctrlKey || event.metaKey) && event.key === 'v') {
                        const activeElement = document.activeElement;
                        const chatInput = document.getElementById('chat-message-input');
                        
                        if (activeElement === chatInput) {
                            event.preventDefault(); // IMPORTANTE: Previne o comportamento padr√£o
                            
                            // Usa o event.clipboardData em vez de navigator.clipboard (mais confi√°vel)
                            const clipboardItems = event.clipboardData || window.clipboardData;
                            
                            if (clipboardItems && clipboardItems.items) {
                                for (let i = 0; i < clipboardItems.items.length; i++) {
                                    const item = clipboardItems.items[i];
                                    
                                    if (item.type.startsWith('image/')) {
                                        const blob = item.getAsFile();
                                        handleImageSelection(blob);
                                        
                                        // Feedback visual
                                        const originalPlaceholder = chatInput.placeholder;
                                        chatInput.placeholder = '‚úÖ Imagem colada! Digite uma mensagem (opcional)...';
                                        setTimeout(() => {
                                            chatInput.placeholder = originalPlaceholder;
                                        }, 2000);
                                        break;
                                    }
                                }
                            } else {
                                // Fallback para navegadores mais antigos
                                console.log('Clipboard API n√£o suportada, tentando m√©todo alternativo...');
                                tryPasteAlternativeMethod();
                            }
                        }
                    }
                }

                                    // Adicionar event listener para Ctrl+V
                                    // Remove event listener antigo se existir
                document.removeEventListener('keydown', handlePaste);

                // Adiciona o event listener corrigido
                document.addEventListener('keydown', handlePaste);

                // Adiciona tamb√©m suporte para o evento 'paste' nativo
                document.addEventListener('paste', function(e) {
                    const activeElement = document.activeElement;
                    const chatInput = document.getElementById('chat-message-input');
                    
                    if (activeElement === chatInput) {
                        const clipboardData = e.clipboardData || window.clipboardData;
                        
                        if (clipboardData && clipboardData.items) {
                            for (let i = 0; i < clipboardData.items.length; i++) {
                                const item = clipboardData.items[i];
                                
                                if (item.type.startsWith('image/')) {
                                    e.preventDefault(); // Importante: previne o colar padr√£o de texto
                                    const blob = item.getAsFile();
                                    handleImageSelection(blob);
                                    
                                    // Feedback visual melhorado
                                    showPasteFeedback(chatInput, '‚úÖ Imagem colada com sucesso!');
                                    break;
                                }
                            }
                        }
                    }
                });

                    // Fun√ß√£o para mostrar feedback visual
                    function showPasteFeedback(inputElement, message) {
                        const feedback = document.createElement('div');
                        feedback.className = 'image-paste-feedback';
                        feedback.textContent = message;
                        
                        const rect = inputElement.getBoundingClientRect();
                        feedback.style.left = rect.left + 'px';
                        feedback.style.top = (rect.top - 30) + 'px';
                        
                        document.body.appendChild(feedback);
                        
                        setTimeout(() => {
                            if (document.body.contains(feedback)) {
                                document.body.removeChild(feedback);
                            }
                        }, 2000);
                    }

                    // Modificar o evento de submit do formul√°rio do chat
                   form.onsubmit = function(e) {
                        e.preventDefault();
                        const message = chatInput.value.trim();
                        
                        // S√≥ envia se tiver mensagem OU imagem
                        if (message || selectedImageBase64) {
                            // Prepara os dados para enviar
                            const messageData = {
                                'message': message
                            };
                            
                            // Adiciona a imagem em Base64 se existir
                            if (selectedImageBase64) {
                                messageData.image_base64 = selectedImageBase64;
                                // Tenta obter informa√ß√µes do arquivo, mas usa valores padr√£o se n√£o dispon√≠vel
                                const file = imageInput.files && imageInput.files[0];
                                messageData.image_type = file ? file.type : 'image/png';
                                messageData.image_name = file ? file.name : 'imagem_colada.png';
                            }
                            
                            // Envia via WebSocket
                            chatSocket.send(JSON.stringify(messageData));
                            
                            // Limpa os inputs
                            chatInput.value = '';
                            selectedImageBase64 = null;
                            imageInput.value = '';
                            
                            // Remove o indicador visual da imagem
                            const imageButton = document.querySelector(`label[for="chat-image-input-${id}"]`);
                            const indicator = imageButton?.querySelector('.image-indicator');
                            if (indicator) {
                                indicator.remove();
                            }
                            
                            console.log('Mensagem enviada:', message ? 'com texto' : 'apenas imagem');
                        }
                    };

                    // Modificar o handler de mensagens para exibir imagens em Base64 com funcionalidade de expandir
                    chatSocket.onmessage = function(e) {
                        const data = JSON.parse(e.data);
                        
                        const message = data.message;
                        const author = data.author;
                        const timestamp = data.timestamp;
                        const imageBase64 = data.image_base64;
                        const imageType = data.image_type;
                        const imageName = data.image_name;

                        if (chatMessages) {
                            const messageElement = document.createElement('div');
                            messageElement.classList.add('chat-message');
                            
                            if (author === loggedInUsername) {
                                messageElement.classList.add('my-message');
                            } else {
                                messageElement.classList.add('other-message');
                            }
                            
                            let messageContent = `<div><strong>${author}:</strong> ${message || ''}`;
                            
                            // Adicionar imagem se existir (usando Base64 diretamente)
                            if (imageBase64) {
                                messageContent += `<br><img src="${imageBase64}" alt="${imageName || 'Imagem'}" class="chat-image" onclick="expandImage('${imageBase64}')">`;
                            }
                            
                            messageContent += `</div><small class="chat-message-time">${new Date(timestamp).toLocaleString()}</small>`;
                            
                            messageElement.innerHTML = messageContent;
                            chatMessages.appendChild(messageElement);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            
                            // Adicionar event listener para as imagens rec√©m-criadas
                            const newImages = messageElement.querySelectorAll('.chat-image');
                            newImages.forEach(img => {
                                img.addEventListener('click', function() {
                                    expandImage(this.src);
                                });
                            });
                        }
                    };

                    // Tamb√©m adicione esta fun√ß√£o globalmente para funcionar em todas as imagens
                    window.expandImage = expandImage;

                    // --- FIM DA L√ìGICA DE UPLOAD ---
                    document.querySelectorAll('.flatpickr').forEach(input => {
                        const fpConfig = {
                            allowInput: true,
                            dateFormat: 'd/m/Y',
                            plugins: [function(instance) {
                                return {
                                    onReady: function() {
                                        // Bot√£o LIMPAR
                                        const containerFooterPopup = document.createElement('div')
                                        containerFooterPopup.className = 'containerFooterPopup'
                                        
                                        const clearButton = document.createElement('button');
                                        clearButton.className = 'clear-date-btn';
                                        clearButton.textContent = 'Limpar';
                                        clearButton.type = 'button';

                                        const todayButton = document.createElement('button');
                                        todayButton.className = 'today-date-btn';
                                        todayButton.textContent = 'Hoje';
                                        todayButton.type = 'button';

                                        clearButton.addEventListener('click', function(e) {
                                            e.stopPropagation();
                                            instance.clear();
                                            instance.input.value = '';
                                            instance.close();

                                            const recordId = instance.input.closest('[data-id]')?.getAttribute('data-id');
                                            const fieldName = instance.input.closest('[data-column]')?.getAttribute('data-column');
                                            
                                            fetch('{% url "update_ocorrencia" %}', {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                    'X-CSRFToken': getCookie('csrftoken')
                                                },
                                                body: JSON.stringify({
                                                    id: recordId,
                                                    field: fieldName,
                                                    value: '',
                                                    page_num: page_num
                                                })
                                            })
                                            .then(response => response.json())
                                            .then(data => {
                                                if (data.status === 'success') {
                                                    const changeEvent = new Event('change', { bubbles: true });
                                                    instance.input.dispatchEvent(changeEvent);
                                                    applyFiltersAndSort(false);
                                                }
                                            });
                                        });

                                        todayButton.addEventListener('click', function(e) {
                                            e.stopPropagation();
                                            const today = new Date();
                                            instance.setDate(today, true); // true => dispara onChange
                                            instance.close();
                                        });

                                        // Adiciona os dois bot√µes
                                        containerFooterPopup.appendChild(todayButton)
                                        containerFooterPopup.appendChild(clearButton)
                                        instance.calendarContainer.appendChild(containerFooterPopup);
                                       
                                    }
                                };
                            }]
                        };

                        flatpickr(input, fpConfig);

                        // j√° usa a l√≥gica existente de salvar
                        input.addEventListener('change', (e) => {
                            atualizarDadosPopup(e.target);
                        });
                    });

                }
            });
        }
        
        function handleGerarPdf(recordId, recordCode) {
            // Mostra um feedback de carregamento para o usu√°rio
            Swal.fire({
                title: 'Gerando PDF...',
                text: 'Por favor, aguarde um momento.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // URL da nossa nova view que aceita POST
            const url = '{% url "gerar_pdf_ocorrencia_post" %}';

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // Essencial para requisi√ß√µes POST no Django
                },
                body: JSON.stringify({
                    record_id: recordId
                })
            })
            .then(response => {
                if (!response.ok) {
                    // Se a resposta n√£o for OK, tenta ler o erro como JSON
                    return response.json().then(err => { throw new Error(err.message || 'Erro no servidor') });
                }
                // Pega o nome do arquivo do cabe√ßalho 'Content-Disposition'
                const disposition = response.headers.get('Content-Disposition');
                let filename = `ocorrencia_${recordCode}.pdf`; // Nome padr√£o
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                // Retorna o corpo da resposta como um Blob
                return response.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                // Cria uma URL tempor√°ria para o Blob (o arquivo PDF em mem√≥ria)
                const blobUrl = window.URL.createObjectURL(blob);

                // Cria um elemento de link <a> invis√≠vel
                const link = document.createElement('a');
                link.style.display = 'none';
                link.href = blobUrl;
                link.download = filename; // Define o nome do arquivo para o download

                // Adiciona o link ao corpo do documento e simula um clique
                document.body.appendChild(link);
                link.click();

                // Limpa a URL do Blob e remove o link
                window.URL.revokeObjectURL(blobUrl);
                document.body.removeChild(link);

                // Fecha o alerta de carregamento
                Swal.close();
            })
            .catch(error => {
                console.error('Erro ao gerar PDF:', error);
                Swal.fire(
                    'Erro!',
                    'N√£o foi poss√≠vel gerar o PDF: ' + error.message,
                    'error'
                );
            });
        }
        window.showProblemDetails = showProblemDetails;
    
        // Nova fun√ß√£o para lidar com a atualiza√ß√£o de dados no pop-up
        let typingTimerPopup;
        const doneTypingIntervalPopup = 100; // Tempo menor para salvar no pop-up, se desejar

        function atualizarDadosPopup(inputElement) {
            clearTimeout(typingTimerPopup);
            const initialValue = inputElement.getAttribute('data-initial-value');
            const currentValue = inputElement.value;

            if (currentValue !== initialValue) {
                inputElement.classList.add('pending-save');
                typingTimerPopup = setTimeout(() => saveFieldPopup(inputElement), doneTypingIntervalPopup);
            }
        }

        function saveFieldPopup(inputElement) {
            const recordID = inputElement.getAttribute('data-record-id');
            const fieldName = inputElement.getAttribute('data-field-name');
            const newValue = inputElement.value;

            inputElement.classList.remove('pending-save');
            inputElement.classList.add('saving'); // Opcional: Adicionar uma classe para indicar salvamento

            fetch('{% url "update_ocorrencia" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN // Use o CSRF_TOKEN j√° definido
                },
                body: JSON.stringify({
                    id: recordID,
                    field: fieldName,
                    value: newValue,
                    // N√£o precisa de page_num aqui, a menos que a atualiza√ß√£o afete a pagina√ß√£o
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na requisi√ß√£o');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    inputElement.classList.remove('saving');
                    inputElement.classList.add('success');
                    inputElement.setAttribute('data-initial-value', newValue); // Atualiza o valor inicial
                    
                    // Opcional: Atualizar a tabela principal para refletir a mudan√ßa imediatamente
                    // Isso pode ser feito chamando applyFiltersAndSort() ou atualizando a c√©lula espec√≠fica
                    // Se voc√™ quiser que a tabela principal reflita a mudan√ßa, chame applyFiltersAndSort()
                    applyFiltersAndSort(); 
                } else {
                    throw new Error(data.message || 'Erro desconhecido');
                }
                setTimeout(() => inputElement.classList.remove('success'), 2000); // Remove a classe 'success' ap√≥s 2s
            })
            .catch(error => {
                console.error('Erro ao salvar no pop-up:', error.message);
                inputElement.classList.remove('saving');
                inputElement.classList.add('error');
                setTimeout(() => inputElement.classList.remove('error'), 5000);
            });
        }


        var page_num = 1
        let buttons_paginator = document.querySelectorAll('.button-paginator')
        var total_pages
        

        buttons_paginator.forEach(button=>{
            button.addEventListener('click', (e)=>{
                if(e.target.id == "next" && page_num <= total_pages){
                    page_num += 1
                }
                else if(e.target.id == "last" && page_num > 1){
                    page_num -= 1
                }
                applyFiltersAndSort()
            })
            
        })

        const buttons={
                elements: document.querySelector("#paginate #num_pages"),
                
                create(number){
                    const button = document.createElement("div")
                    button.innerHTML = number
                    button.className='page-item'

                    if(page_num == number){
                        button.classList.add("active")
                    }

                    buttons.elements.appendChild(button)
                },
                update(){
                    buttons.elements.innerHTML = ''
                    const {maxLeft, maxRight} = buttons.calculateMaxVisible()
                    
                    for(let page = maxLeft; page <= maxRight; page++){
                        buttons.create(page)
                    }

                },
                calculateMaxVisible(){
                    const maxVisibleButtons = 3
                    let maxLeft = (page_num - Math.floor(maxVisibleButtons/2))
                    let maxRight = (page_num + Math.floor(maxVisibleButtons/2))
                    
                    if(maxLeft < 1){
                        maxLeft = 1
                        maxRight = maxVisibleButtons
                    }
                    if(maxRight > total_pages){
                        maxLeft = total_pages - (maxVisibleButtons - 1)
                        maxRight = total_pages
                        if(maxLeft < 1){
                            maxLeft = 1
                        }
                    }
                    return {maxLeft, maxRight}
                }
            }

        function paginate(hasPrev, hasNext){
            const buttonPrev = document.getElementById("last")
            const buttonNext = document.getElementById("next")
            if(!hasPrev && hasNext){   
                buttonPrev.style.visibility = 'hidden'
                buttonNext.style.visibility = 'visible'
            }
            else if(!hasNext && hasPrev){
                buttonPrev.style.visibility = 'visible'
                buttonNext.style.visibility = 'hidden'
            }
            else if(!hasNext && !hasPrev){
                buttonPrev.style.visibility = 'hidden'
                buttonNext.style.visibility = 'hidden'
            }
            else{
                buttonPrev.style.visibility = 'visible'
                buttonNext.style.visibility = 'visible'
            }
            buttons.update()
        }

        function isValidDate(input) {
            // Verifica o formato com regex: dd/mm/yyyy
            const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const match = input.match(regex);

            if (!match) return false;

            const day = parseInt(match[1], 10);
            const month = parseInt(match[2], 10);
            const year = parseInt(match[3], 10);

            // Valida m√™s de 1 a 12
            if (month < 1 || month > 12) return false;

            // Cria a data com JS (os meses s√£o de 0 a 11)
            const date = new Date(year, month - 1, day);

            // Verifica se o dia, m√™s e ano conferem
            return (
                date.getFullYear() === year &&
                date.getMonth() === month - 1 &&
                date.getDate() === day
            );
        }

        const table = document.getElementById("data-table");
        if (!table) {
            console.error("Erro: Tabela com ID \"data-table\" n√£o encontrada.");
            return;
        }
        const tableBody = document.getElementById("table-body");
        if (!tableBody) {
            console.error("Erro: Corpo da tabela com ID \"table-body\" n√£o encontrado.");
            return;
        }
        
        const headers = Array.from(table.querySelectorAll("thead th[data-column]")); 
        //console.log("Cabe√ßalhos encontrados no DOM:", headers.map(h => h.getAttribute("data-column")));

        const headerData = headers
            .map((header) => ({
                element: header,
                columnName: header.getAttribute("data-column"),
                filterBox: header.querySelector(".filter-box"),
                isDateColumn: ["data", "deadline", "finished"].includes(
                    header.getAttribute("data-column")
                ),
                isTextAreaColumn: ["feedback_technical", "feedback_manager"].includes(
                    header.getAttribute("data-column")
                ),
            }))
            .filter((h) => h.columnName);

        // console.log("HeaderData processado:", headerData.map(h => ({ col: h.columnName, hasFilterBox: !!h.filterBox })));

        let openFilterBox = null;
        let currentFilters = {}; 
        let currentSort = { column: "data", direction: "desc" };
        let currentFilterOptions = {}; // Armazena as op√ß√µes de filtro recebidas do backend
        const CSRF_TOKEN = getCookie("csrftoken");

        // --- Fun√ß√µes Auxiliares --- 
        

        function parseDateToISO(dateString) { 
            if (!dateString || typeof dateString !== "string") return dateString;
            const parts = dateString.trim().split("/");
            if (parts.length === 3) {
                const [day, month, year] = parts;
                if (
                    day.length === 2 &&
                    month.length === 2 &&
                    year.length === 4 &&
                    !isNaN(parseInt(day)) &&
                    !isNaN(parseInt(month)) &&
                    !isNaN(parseInt(year))
                ) {
                    return `${year}-${month}-${day}`;
                }
            }
            if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return dateString;
            }
            return dateString;
        }
        
        function formatDateToDisplay(isoDateString) { 
            if (!isoDateString || typeof isoDateString !== "string") return "";
            const parts = isoDateString.split("-");
            if (parts.length === 3) {
                const [year, month, day] = parts;
                if (
                    day.length === 2 &&
                    month.length === 2 &&
                    year.length === 4 &&
                    !isNaN(parseInt(day)) &&
                    !isNaN(parseInt(month)) &&
                    !isNaN(parseInt(year))
                ) {
                    return `${day}/${month}/${year}`;
                }
            }
            return isoDateString;
        }

        // --- NOVA FUN√á√ÉO: Gerar ID √∫nico e v√°lido ---
        function generateUniqueId(prefix, value, index = '') {
            // Remove caracteres especiais e espa√ßos, substitui por underscore
            const sanitizedValue = String(value || 'empty')
                .replace(/[^a-zA-Z0-9]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '');
            
            // Adiciona timestamp para garantir unicidade
            const timestamp = Date.now();
            const randomSuffix = Math.random().toString(36).substr(2, 5);
            
            return `${prefix}_${sanitizedValue}_${index}_${timestamp}_${randomSuffix}`;
        }

        // --- L√≥gica de UI (Filter Box) --- 
        function positionFilterBox(headerElement, filterBoxElement) { 
            const headerRect = headerElement.getBoundingClientRect();
            const tableRect = table.getBoundingClientRect();
            filterBoxElement.style.top = `${headerRect.bottom - tableRect.top + window.scrollY + 2}px`;
            filterBoxElement.style.display = "block";
            const boxRect = filterBoxElement.getBoundingClientRect();
        }

        // *** FUN√á√ÉO CORRIGIDA E MELHORADA: Criar a √°rvore de datas hier√°rquica com toggles ***
        function createDateTreeHTML(columnName, dateTree, level = 0) {
            let html = '';
            const sortedYears = Object.keys(dateTree).sort((a, b) => parseInt(a) - parseInt(b)); // Ordena anos numericamente

            sortedYears.forEach((year) => {
                const yearId = generateUniqueId(`date_${columnName}_year`, year);
                const yearToggleId = `toggle_${yearId}`;
                const yearContentId = `content_${yearId}`;

                html += `
                <div class="filter-tree-node" data-level="year">
                    <div class="node-header">
                        <span class="toggle-icon" id="${yearToggleId}">‚ñ∂</span>
                        <input type="checkbox" id="${yearId}" data-filter-option="${columnName}" data-tree-level="year" value="${year}">
                        <label for="${yearId}">${year}</label>
                    </div>
                    <div class="node-content" id="${yearContentId}" style="display: none;">`; // Escondido por padr√£o

                const sortedMonths = Object.keys(dateTree[year]).sort((a, b) => parseInt(a) - parseInt(b)); // Ordena meses numericamente
                sortedMonths.forEach((month) => {
                    const monthName = new Date(2000, parseInt(month) - 1, 1).toLocaleString('pt-BR', { month: 'long' });
                    const monthId = generateUniqueId(`date_${columnName}_month`, `${year}_${month}`);
                    const monthToggleId = `toggle_${monthId}`;
                    const monthContentId = `content_${monthId}`;

                    html += `
                        <div class="filter-tree-node" data-level="month">
                            <div class="node-header" style="margin-left: 20px;">
                                <span class="toggle-icon" id="${monthToggleId}">‚ñ∂</span>
                                <input type="checkbox" id="${monthId}" data-filter-option="${columnName}" data-tree-level="month" value="${year}-${month}">
                                <label for="${monthId}">${capitalize(monthName)}</label>
                            </div>
                            <div class="node-content" id="${monthContentId}" style="display: none;">`; // Escondido por padr√£o

                    const sortedDays = dateTree[year][month].sort((a, b) => parseInt(a) - parseInt(b)); // Ordena dias numericamente
                    sortedDays.forEach((day) => {
                        const dayId = generateUniqueId(`date_${columnName}_day`, `${year}_${month}_${day}`);
                        const fullDateValue = `${year}-${month}-${day}`;
                        html += `
                            <div class="filter-tree-node" data-level="day" style="margin-left: 40px;">
                                <input type="checkbox" id="${dayId}" data-filter-option="${columnName}" data-tree-level="leaf" value="${fullDateValue}">
                                <label for="${dayId}">${day}</label>
                            </div>`;
                    });
                    html += `</div></div>`; // Fecha node-content e filter-tree-node (month)
                });
                html += `</div></div>`; // Fecha node-content e filter-tree-node (year)
            });
            return html;
        }

        // *** FUN√á√ÉO CORRIGIDA E MELHORADA: Popular a caixa de filtro com IDs √∫nicos e l√≥gica de toggle ***
        function populateFilterBox(filterBoxElement, headerInfo) {
            const columnName = headerInfo.columnName;
            let options = currentFilterOptions[columnName] || (headerInfo.isDateColumn ? {} : []);
            
            // Para filtros n√£o-data, garante que as op√ß√µes sejam um array e √∫nicas
            if (!headerInfo.isDateColumn) {
                try {
                    // --- IN√çCIO DA NOVA L√ìGICA PARA PADRONIZA√á√ÉO E UNICIDADE CASE-INSENSITIVE ---
                    const processedOptions = new Set(); // Usamos um Set para garantir unicidade
                    const uniqueOptions = []; // Array para as op√ß√µes finais, mantendo a ordem de inser√ß√£o ou ordenando depois

                    options.forEach(option => {
                        if (typeof option === "string") {
                            const trimmedUpper = option.trim().toUpperCase(); // Padroniza para mai√∫sculas
                            if (!processedOptions.has(trimmedUpper)) {
                                processedOptions.add(trimmedUpper);
                                uniqueOptions.push(option.trim()); // Adiciona a vers√£o original (trim) para exibi√ß√£o
                            }
                        } else {
                            // Se n√£o for string, adiciona como est√° (ex: n√∫meros, booleanos)
                            if (!processedOptions.has(option)) { // Verifica unicidade para n√£o-strings tamb√©m
                                processedOptions.add(option);
                                uniqueOptions.push(option);
                            }
                        }
                    });
                    options = uniqueOptions.sort((a, b) => {
                        // Ordena as op√ß√µes, tratando strings de forma case-insensitive
                        if (typeof a === 'string' && typeof b === 'string') {
                            return a.localeCompare(b, undefined, { sensitivity: 'base' });
                        }
                        return String(a).localeCompare(String(b)); // Para outros tipos, converte para string e compara
                    });
                    // --- FIM DA NOVA L√ìGICA ---

                } catch (e) {
                    console.error("Erro ao processar op√ß√µes de filtro n√£o-data:", e);
                    options = [];
                }
            }


            const isDate = headerInfo.isDateColumn;
            const savedFilter = currentFilters[columnName] || { values: [], isApplied: false };
            
            let optionsHTML = '';
            if (isDate) {
                if (Object.keys(options).length > 0) {
                    optionsHTML = createDateTreeHTML(columnName, options);
                } else {
                    optionsHTML = '<p style="padding: 5px; color: grey;">Nenhuma data dispon√≠vel.</p>';
                }
            } else {
                if (options.length > 0) {
                    options.forEach((option, index) => {
                        const optionId = generateUniqueId(`filter_${columnName}`, option, index);
                        const isChecked = savedFilter.isApplied && savedFilter.values.includes(option);
                        optionsHTML += `<div class="filter-option">
                                        <input type="checkbox" id="${optionId}" data-filter-option="${columnName}" data-tree-level="leaf" value="${option}" ${isChecked ? 'checked' : ''}>
                                        <label for="${optionId}">${option || '(Vazio)'}</label>
                                      </div>`;
                    });
                } else {
                    optionsHTML = '<p style="padding: 5px; color: grey;">Nenhuma op√ß√£o dispon√≠vel.</p>';
                }
            }

            filterBoxElement.innerHTML = `
                <div class="filter-header">
                    <input type="checkbox" id="select-all-${columnName}">
                    <label for="select-all-${columnName}">Selecionar Todos</label>
                </div>
                ${!isDate ? `<input type="text" class="filter-search-input" placeholder="Buscar...">` : ''}
                <div class="filter-options">${optionsHTML}</div>
                <div class="filter-actions">
                    <button class="apply-filter-btn">Aplicar</button>
                    <button class="clear-filter-btn">Limpar</button>
                </div>
            `;

            const selectAllCheckbox = filterBoxElement.querySelector(`#select-all-${columnName}`);
            const searchInput = filterBoxElement.querySelector('.filter-search-input');
            const applyButton = filterBoxElement.querySelector('.apply-filter-btn');
            const clearButton = filterBoxElement.querySelector('.clear-filter-btn');
            const optionCheckboxes = filterBoxElement.querySelectorAll('input[type="checkbox"][data-filter-option]');

            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const isChecked = this.checked;
                    optionCheckboxes.forEach(checkbox => {
                        checkbox.checked = isChecked;
                    });
                });
            }

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const filterOptions = filterBoxElement.querySelectorAll('.filter-option');
                    
                    filterOptions.forEach(option => {
                        const label = option.querySelector('label');
                        if (label) {
                            const text = label.textContent.toLowerCase();
                            option.style.display = text.includes(searchTerm) ? 'block' : 'none';
                        }
                    });
                });
            }

            if (applyButton) {
                applyButton.addEventListener('click', function() {
                    const selectedValues = [];
                    optionCheckboxes.forEach(checkbox => {
                        if (checkbox.checked) {
                            selectedValues.push(checkbox.value);
                        }
                    });

                    currentFilters[columnName] = {
                        values: selectedValues,
                        isApplied: selectedValues.length > 0
                    };

                    applyFiltersAndSort(true);
                });
            }

            if (clearButton) {
                clearButton.addEventListener('click', function() {
                    currentFilters[columnName] = { values: [], isApplied: false };
                    applyFiltersAndSort(true);
                });
            }

            if (isDate) {
                addDateHierarchyToggle(filterBoxElement, columnName);
            }
        }

        // *** NOVA FUN√á√ÉO: Adicionar funcionalidade de toggle hier√°rquico para datas e sincroniza√ß√£o de checkboxes ***
        function addDateHierarchyToggle(filterBoxElement, columnName) {
            const toggleIcons = filterBoxElement.querySelectorAll('.toggle-icon');
            
            toggleIcons.forEach(icon => {
                icon.addEventListener('click', function() {
                    const contentId = `content_${this.id.replace('toggle_', '')}`;
                    const contentElement = filterBoxElement.querySelector(`#${contentId}`);
                    if (contentElement) {
                        if (contentElement.style.display === 'none') {
                            contentElement.style.display = 'block';
                            this.textContent = '‚ñº'; // Seta para baixo
                        } else {
                            contentElement.style.display = 'none';
                            this.textContent = '‚ñ∂'; // Seta para a direita
                        }
                    }
                });
            });

            // Sincroniza√ß√£o de checkboxes
            filterBoxElement.addEventListener('change', function(event) {
                const target = event.target;
                if (target.type === 'checkbox' && target.dataset.filterOption === columnName) {
                    const level = target.dataset.treeLevel;
                    const value = target.value;
                    const isChecked = target.checked;

                    if (level === 'year') {
                        // Se um ano √© marcado/desmarcado, afeta todos os meses e dias abaixo dele
                        filterBoxElement.querySelectorAll(`input[data-tree-level="month"][value^="${value}-"], input[data-tree-level="leaf"][value^="${value}-"]`).forEach(checkbox => {
                            checkbox.checked = isChecked;
                        });
                    } else if (level === 'month') {
                        // Se um m√™s √© marcado/desmarcado, afeta todos os dias abaixo dele
                        filterBoxElement.querySelectorAll(`input[data-tree-level="leaf"][value^="${value}-"]`).forEach(checkbox => {
                            checkbox.checked = isChecked;
                        });

                        // Verifica o estado do ano pai
                        const year = value.split('-')[0];
                        const yearCheckbox = filterBoxElement.querySelector(`input[data-tree-level="year"][value="${year}"]`);
                        if (yearCheckbox) {
                            const allMonthsOfYear = filterBoxElement.querySelectorAll(`input[data-tree-level="month"][value^="${year}-"]`);
                            const checkedMonthsOfYear = filterBoxElement.querySelectorAll(`input[data-tree-level="month"][value^="${year}-"]:checked`);
                            yearCheckbox.checked = allMonthsOfYear.length === checkedMonthsOfYear.length;
                        }
                    } else if (level === 'leaf') {
                        // Se um dia √© marcado/desmarcado, verifica o estado do m√™s pai
                        const yearMonth = value.substring(0, value.lastIndexOf('-')); // Ex: "2023-01"
                        const monthCheckbox = filterBoxElement.querySelector(`input[data-tree-level="month"][value="${yearMonth}"]`);
                        if (monthCheckbox) {
                            const allDaysOfMonth = filterBoxElement.querySelectorAll(`input[data-tree-level="leaf"][value^="${yearMonth}-"]`);
                            const checkedDaysOfMonth = filterBoxElement.querySelectorAll(`input[data-tree-level="leaf"][value^="${yearMonth}-"]:checked`);
                            monthCheckbox.checked = allDaysOfMonth.length === checkedDaysOfMonth.length;
                        }

                        // E tamb√©m verifica o estado do ano pai
                        const year = value.split('-')[0];
                        const yearCheckbox = filterBoxElement.querySelector(`input[data-tree-level="year"][value="${year}"]`);
                        if (yearCheckbox) {
                            const allMonthsOfYear = filterBoxElement.querySelectorAll(`input[data-tree-level="month"][value^="${year}-"]`);
                            const checkedMonthsOfYear = filterBoxElement.querySelectorAll(`input[data-tree-level="month"][value^="${year}-"]:checked`);
                            yearCheckbox.checked = allMonthsOfYear.length === checkedMonthsOfYear.length;
                        }
                    }
                }
            });
        }

        // --- L√≥gica de Filtragem e Ordena√ß√£o ---
        function applyFiltersAndSort(closeBox = false) {
            // 1. Preparar dados de filtro
            const filterData = {
                filters: {},
                sort: currentSort,
                page: page_num
            };
            if('{{has_edit_permission}}' == 'False'){
                filterData.filters['responsible'] = []
                filterData.filters['responsible'].push('{{user}}'.toUpperCase())
            }

            // 2. Processar filtros ativos
            Object.keys(currentFilters).forEach(columnName => {
                const filter = currentFilters[columnName];
                if (filter.isApplied && filter.values.length > 0) {
                    const headerInfo = headerData.find(h => h.columnName === columnName);
                    
                    if (headerInfo?.isDateColumn) {
                        // Para datas, converter para ISO
                        filterData.filters[columnName] = filter.values.map(parseDateToISO);
                    } else {
                        filterData.filters[columnName] = filter.values;
                    }
                }
            });

            // 3. Enviar para o backend
            fetch("{% url 'filter_data' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": CSRF_TOKEN,
                },
                body: JSON.stringify(filterData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                
                currentFilterOptions = data.filter_options || {};
                // console.log(data)
                updateTable(data.records);
                total_pages = data.num_pages;
                paginate(data.has_previous, data.has_next);

                // --- IN√çCIO DA NOVA L√ìGICA PARA FEEDBACK VISUAL DE FILTRO ---
                // Remove a classe 'filtered' de todos os cabe√ßalhos primeiro
                headers.forEach(header => {
                    header.classList.remove('filtered');
                });

                // Adiciona a classe 'filtered' aos cabe√ßalhos com filtros ativos
                Object.keys(currentFilters).forEach(columnName => {
                    const filter = currentFilters[columnName];
                    if (filter.isApplied && filter.values.length > 0) {
                        const headerInfo = headerData.find(h => h.columnName === columnName);
                        if (headerInfo && headerInfo.element) {
                            headerInfo.element.classList.add('filtered');
                        }
                    }
                });
                // --- FIM DA NOVA L√ìGICA PARA FEEDBACK VISUAL DE FILTRO ---

            })
            .catch(error => {
                console.error("Erro ao filtrar:", error);
                Swal.fire("Erro", "Ocorreu um erro ao aplicar os filtros.", "error");
            });

            // 4. Fechar a caixa de filtro se necess√°rio
            if (closeBox && openFilterBox) {
                openFilterBox.style.display = "none";
                openFilterBox = null;
            }
        }
        window.applyFiltersAndSort = applyFiltersAndSort;
    

        /**
        * Atualiza o corpo da tabela.
        */
        // ===== SISTEMA DE ATUALIZA√á√ÉO DIN√ÇMICA DE STATUS =====
        // Simula o comportamento de useEffect do React em JavaScript puro
        // (Defini√ß√µes movidas para escopo global)

        // Fun√ß√£o pura para calcular o status baseado nas datas (MODIFICADA)
        function calculateStatus(record) {
            const deadlineStr = record.deadline;
            const finishedStr = record.finished;
            
            const parseDate = (dateStr) => {
                if (!dateStr || dateStr === "N√£o definido" || dateStr === "N√£o finalizado") return null;
                const [day, month, year] = dateStr.split('/').map(Number);
                return new Date(year, month - 1, day);
            };
            
            // PRIORIDADE 1: Verificar se √© um caso especial da China
            const chinaStatus = calculateChinaStatus(record);
            if (chinaStatus) {
                // Registrar no observer para monitoramento cont√≠nuo
                chinaStatusObserver.observe(record.id, record);
                return chinaStatus;
            }
            
            // PRIORIDADE 2: L√≥gica original para outros status
            const deadlineDate = parseDate(deadlineStr);
            // if (!deadlineDate) return 'Requisitado';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const deadline = new Date(deadlineDate);
            deadline.setHours(0, 0, 0, 0);

            if (finishedStr && finishedStr !== "N√£o finalizado") {
                return 'Conclu√≠do';
            }
            
            if (!deadlineStr || deadlineStr === "N√£o definido") {
                return 'Requisitado';
            }
            
            if (today > deadline) {
                return 'Atrasado';
            } else {
                return 'Em progresso';
            }
        }


        // Fun√ß√£o para atualizar o status de um registro espec√≠fico
        function updateRecordStatus(recordId, newStatus) {
            const statusCell = document.querySelector(`[data-column="status"][data-id="${recordId}"]`);
            if (!statusCell) return;
            
            const currentStatus = statusCell.textContent.trim();
            
            // S√≥ atualiza se o status mudou
            if (currentStatus !== newStatus) {
                statusCell.textContent = newStatus;
                
                // CORRE√á√ÉO: Persistir status China no backend usando a API correta
                const statusCode = newStatus === 'China Atrasada' ? 'AWAITING_CHINA_LATE' : 
                                 newStatus === 'Aguardando China' ? 'AWAITING_CHINA' : newStatus;
                
                fetch('{% url "update_ocorrencia" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        id: recordId,
                        field: 'status',
                        value: statusCode,
                        page_num: page_num
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        statusCell.setAttribute('data-initial-value', newStatus);
                    } else {
                        console.error('Erro ao persistir status China:', data.message);
                        // Reverte o status na interface se falhou no backend
                        statusCell.textContent = currentStatus;
                    }
                })
                .catch(error => {
                    console.error('Erro de rede ao persistir status China:', error);
                    // Reverte o status na interface se falhou no backend
                    statusCell.textContent = currentStatus;
                });
            }
        }

        // Fun√ß√£o para recalcular todos os status
        function recalculateAllStatus() {
            statusUpdateSystem.records.forEach(record => {
                const newStatus = calculateStatus(record);
                updateRecordStatus(record.id, newStatus);
            });
        }

        // Fun√ß√£o para recalcular status de um registro espec√≠fico
        function recalculateRecordStatus(recordId) {
            const record = statusUpdateSystem.records.find(r => r.id == recordId);
            if (!record) return;
            
            // Atualiza os dados do record com os valores atuais dos inputs
            const deadlineInput = document.querySelector(`[data-column="deadline"][data-id="${recordId}"] input`);
            const finishedInput = document.querySelector(`[data-column="finished"][data-id="${recordId}"] input`);
            
            if (deadlineInput) {
                record.deadline = deadlineInput.value || deadlineInput.placeholder;
            }
            if (finishedInput) {
                record.finished = finishedInput.value || finishedInput.placeholder;
            }
            
            const newStatus = calculateStatus(record);
            updateRecordStatus(recordId, newStatus);
        }

        // Fun√ß√£o com debounce para evitar execu√ß√µes excessivas
        function debounce(func, wait, key) {
            if (statusUpdateSystem.debounceTimers.has(key)) {
                clearTimeout(statusUpdateSystem.debounceTimers.get(key));
            }
            
            const timer = setTimeout(() => {
                func();
                statusUpdateSystem.debounceTimers.delete(key);
            }, wait);
            
            statusUpdateSystem.debounceTimers.set(key, timer);
        }

        // Fun√ß√£o para configurar observadores nos inputs de data
        function setupDateInputObservers() {
            // Remove observadores existentes
            statusUpdateSystem.observers.forEach(observer => observer.disconnect());
            statusUpdateSystem.observers.clear();
            
            // Configura observadores para inputs de deadline e finished
            const dateInputs = document.querySelectorAll('[data-column="deadline"] input, [data-column="finished"] input');
            
            dateInputs.forEach(input => {
                const cell = input.closest('[data-id]');
                if (!cell) return;
                
                const recordId = cell.getAttribute('data-id');
                const columnName = cell.getAttribute('data-column');
                
                // Event listener para mudan√ßas no input
                const handleInputChange = () => {
                    debounce(() => {
                        recalculateRecordStatus(recordId);
                    }, 300, `${recordId}-${columnName}`);
                };
                
                // Remove listeners existentes para evitar duplica√ß√£o
                input.removeEventListener('input', handleInputChange);
                input.removeEventListener('change', handleInputChange);
                input.removeEventListener('blur', handleInputChange);
                
                // Adiciona os listeners
                input.addEventListener('input', handleInputChange);
                input.addEventListener('change', handleInputChange);
                input.addEventListener('blur', handleInputChange);
                
                //console.log(`Observer configurado para ${columnName} do registro ${recordId}`);
            });
            
            // MutationObserver para detectar mudan√ßas no DOM (quando novos inputs s√£o adicionados)
            const tableObserver = new MutationObserver((mutations) => {
                let shouldReconfigure = false;
                
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            const hasDateInputs = node.querySelectorAll && 
                                node.querySelectorAll('[data-column="deadline"] input, [data-column="finished"] input').length > 0;
                            
                            if (hasDateInputs) {
                                shouldReconfigure = true;
                            }
                        }
                    });
                });
                
                if (shouldReconfigure) {
                    debounce(() => {
                        setupDateInputObservers();
                        recalculateAllStatus();
                    }, 100, 'dom-mutation');
                }
            });
            
            // Observa mudan√ßas no tbody da tabela
            const tableBody = document.getElementById('table-body');
            if (tableBody) {
                tableObserver.observe(tableBody, {
                    childList: true,
                    subtree: true
                });
                statusUpdateSystem.observers.set('table-mutation', tableObserver);
            }
        }

        // Fun√ß√£o melhorada updateTable com sistema de atualiza√ß√£o din√¢mica
        function updateTable(records) {
            // Armazena os records no sistema de status
            statusUpdateSystem.records = records || [];
            
            // HOOK: Limpar observers China antes de recriar a tabela
            chinaStatusObserver.clear();
            
            tableBody.innerHTML = "";
            if (!records || records.length === 0) {
                const colspan = table.querySelectorAll("thead th[data-column]").length;
                const noResultsRow = tableBody.insertRow();
                const cell = noResultsRow.insertCell();

                cell.colSpan = colspan > 0 ? colspan : 1;
                cell.textContent = "Nenhum registro encontrado.";
                cell.style.textAlign = "center";
                return;
            }
            
            const visibleColumns = Array.from(table.querySelectorAll("thead th[data-column]")).map(th => th.getAttribute('data-column'));
            const has_full_permission = '{{has_full_permission}}' === 'True';
            const has_edit_permission = '{{ has_edit_permission }}' === 'True';

           records.forEach((record) => {
                const row = tableBody.insertRow();
                visibleColumns.forEach(columnName => {
                    const cell = row.insertCell();
                    cell.setAttribute("data-column", columnName);
                    cell.setAttribute("data-id", record.id);

                    let value = record[columnName];
                    const headerInfo = headerData.find(h => h.columnName === columnName);
                    
                    // --- IN√çCIO DA CORRE√á√ÉO 2: SIMPLIFICAR A L√ìGICA DA COLUNA DE STATUS ---
                    if (columnName === 'status') {
                        // L√ìGICA FINAL E SIMPLIFICADA:
                        // 1. Apenas exibe o texto do status que o backend enviou.
                        cell.textContent = record.status_display; 

                        // 2. Adiciona a classe de estilo para qualquer status de atraso.
                        // Usamos o 'status_code' que vem do backend para uma verifica√ß√£o fi√°vel.
                        if (record.status_code === 'AWAITING_CHINA_LATE' || record.status_code === 'LATE') {
                            cell.classList.add("awaiting-china-late"); // Reutiliza a classe de estilo vermelha
                        }
                    } 
                    // --- FIM DA CORRE√á√ÉO 2 ---
                    
                    else if (headerInfo?.isDateColumn) {
                        if (value) {
                            value = formatDateToDisplay(value);
                        } else {
                            if (columnName == 'finished') {
                                value = "N√£o finalizado"
                            } else {
                                value = 'N√£o definido'
                            }
                        }
                    } if (columnName == 'problem_detected') {
                        cell.classList.add("no-cursor")
                        
                        const container = document.createElement('div');
                        container.style.display = 'flex';
                        container.style.alignItems = 'center';
                        container.style.justifyContent = 'center';
                        
                        const detailsButton = document.createElement('button');
                        detailsButton.innerHTML = 'Ver Detalhes';
                        detailsButton.style.cssText = `
                            background: linear-gradient(135deg, #0056b3 0%, #3a7bc8 100%);
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 0.8rem;
                            font-weight: 600
                        `;
                        
                        detailsButton.addEventListener('mouseenter', function() {
                            this.style.background = 'linear-gradient(135deg, #3a7bc8 0%, #0056b3 100%)';
                            this.style.transform = 'translateY(-1px)';
                            this.style.boxShadow = '0 4px 12px rgba(0, 86, 179, 0.3)';
                        });
                        
                        detailsButton.addEventListener('mouseleave', function() {
                            this.style.background = 'linear-gradient(135deg, #0056b3 0%, #3a7bc8 100%)';
                            this.style.transform = 'translateY(0)';
                            this.style.boxShadow = 'none';
                        });
                        
                        detailsButton.addEventListener('click', function(e) {
                            e.stopPropagation();
                            showProblemDetails(record);
                        });
                        
                        container.appendChild(detailsButton);
                        cell.appendChild(container);

                    } else if (columnName == 'status') {
                        // === L√ìGICA DE STATUS CORRIGIDA ===
                        cell.id = `${columnName}${record.id}`;
                        cell.classList.add('field-container');
                        
                        // CORRE√á√ÉO: Usar o status que vem do backend (record.status_display)
                        // e apenas registrar no observer se for status China
                        const displayStatus = record.status_display || record.status;
                        cell.textContent = displayStatus;
                        cell.setAttribute('data-initial-value', displayStatus);
                        
                        // Se √© status China, registra no observer para monitoramento
                        if (record.status === 'Aguardando China' || record.status === 'China Atrasada') {
                            chinaStatusObserver.observe(record.id, record);
                        }
                        
                        // Adiciona classe de estilo para status atrasados
                        if (record.status_code === 'AWAITING_CHINA_LATE' || record.status_code === 'LATE') {
                            cell.classList.add("awaiting-china-late");
                        }

                    } else if ((columnName == 'deadline' && '{{has_edit_permission}}' === 'True') || columnName == 'finished') {
                        cell.id = `${columnName}${record.id}`
                        cell.classList.add('editable-field-container')
                        cell.classList.add('date-input-container')

                        const textInput = document.createElement('input');
                        textInput.type = 'text';
                        textInput.placeholder = 'DD/MM/AAAA';
                        textInput.classList.add('date-text-input')
                        
                        cell.addEventListener('dblclick', (e) => {
                            navigator.clipboard.writeText(e.target.getAttribute('data-initial-value'))
                            textInput.blur()
                            Swal.fire({
                                title: "Texto copiado",
                                text: 'Data copiada para √°rea de transfer√™ncia',
                                showCloseButton: true,
                                icon: 'success'
                            })
                        })

                        textInput.placeholder = value;
                        textInput.setAttribute('data-initial-value', value)

                        cell.appendChild(textInput);

                        textInput.addEventListener('blur', function(e) {
                            e.target.classList.remove("erro")
                            e.target.classList.remove("success")
                        })

                        textInput.addEventListener('input', function(e) {
                            let value = e.target.value.replace(/\D/g, '');

                            if (value.length > 2) value = value.substring(0, 2) + '/' + value.substring(2);
                            if (value.length > 5) value = value.substring(0, 5) + '/' + value.substring(5, 9);

                            e.target.value = value;
                            
                            if (columnName == 'finished') {
                                if (value.split('/').length != 3) {
                                    e.target.classList.add("erro")
                                    e.target.classList.remove("success")
                                } else {
                                    var deadline_data = new Date(`${record['deadline'].split('/')[2]}-${record['deadline'].split('/')[1]}-${record['deadline'].split('/')[0]}`)
                                    var input_data = new Date(`${value.split('/')[2]}-${value.split('/')[1]}-${value.split('/')[0]}`)

                                    if (value.split('/')[2].length == 4 && isValidDate(value)) {
                                        e.target.classList.remove("erro")
                                        e.target.classList.add("success")
                                        atualizarDados(e)
                                    } else {
                                        e.target.classList.add("erro")
                                        e.target.classList.remove("success")
                                    }
                                }
                            } else if (columnName == 'deadline') {
                                if (value.split('/').length != 3) {
                                    e.target.classList.add("erro")
                                    e.target.classList.remove("success")
                                } else {
                                    var finished = record['finished'] ? new Date(`${record['finished'].split('/')[2]}-${record['finished'].split('/')[1]}-${record['finished'].split('/')[0]}`) : null;
                                    var data = new Date(record['data'])
                                    var input_data = new Date(`${value.split('/')[2]}-${value.split('/')[1]}-${value.split('/')[0]}`)
                                    
                                    if (value.split('/')[2].length == 4 && isValidDate(value)) {
                                        e.target.classList.remove("erro")
                                        e.target.classList.add("success")
                                        atualizarDados(e)
                                    } else {
                                        e.target.classList.add("erro")
                                        e.target.classList.remove("success")
                                    }
                                }
                            }
                        })
                        
                        if (textInput.classList[0] == 'date-text-input') {
                            if (value) {
                                const fpConfig = {
                                    'allowInput': true,
                                    'dateFormat': 'd/m/Y',
                                    'plugins': [function(instance) {
                                        return {
                                            onReady: function() {
                                            // Bot√£o LIMPAR
                                            const containerFooterPopup = document.createElement('div')
                                            containerFooterPopup.className = 'containerFooterPopup'
                                            
                                            const clearButton = document.createElement('button');
                                            clearButton.className = 'clear-date-btn';
                                            clearButton.textContent = 'Limpar';
                                            clearButton.type = 'button';

                                            const todayButton = document.createElement('button');
                                            todayButton.className = 'today-date-btn';
                                            todayButton.textContent = 'Hoje';
                                            todayButton.type = 'button';

                                            clearButton.addEventListener('click', function(e) {
                                                e.stopPropagation();
                                                instance.clear();
                                                instance.input.value = '';
                                                instance.close();

                                                const recordId = instance.input.closest('[data-id]')?.getAttribute('data-id');
                                                const fieldName = instance.input.closest('[data-column]')?.getAttribute('data-column');
                                                
                                                fetch('{% url "update_ocorrencia" %}', {
                                                    method: 'POST',
                                                    headers: {
                                                        'Content-Type': 'application/json',
                                                        'X-CSRFToken': getCookie('csrftoken')
                                                    },
                                                    body: JSON.stringify({
                                                        id: recordId,
                                                        field: fieldName,
                                                        value: '',
                                                        page_num: page_num
                                                    })
                                                })
                                                .then(response => response.json())
                                                .then(data => {
                                                    if (data.status === 'success') {
                                                        const changeEvent = new Event('change', { bubbles: true });
                                                        instance.input.dispatchEvent(changeEvent);
                                                        applyFiltersAndSort(false);
                                                    }
                                                });
                                            });

                                            todayButton.addEventListener('click', function(e) {
                                                e.stopPropagation();
                                                const today = new Date();
                                                instance.setDate(today, true); // true => dispara onChange
                                                instance.close();
                                            });

                                            // Adiciona os dois bot√µes
                                            containerFooterPopup.appendChild(todayButton)
                                            containerFooterPopup.appendChild(clearButton)
                                            instance.calendarContainer.appendChild(containerFooterPopup);
                                        
                                        }
                                        };
                                    }]
                                };
                                flatpickr(textInput, fpConfig);
                            } else {
                                // Configura√ß√£o padr√£o para outros campos
                                flatpickr(textInput, { 
                                    'allowInput': true, 
                                    'dateFormat': 'd/m/Y', 
                                });
                            }
                        }   

                    } else if ((columnName == 'responsible' && '{{has_edit_permission}}' === 'True')) {
                        cell.id = `${columnName}${record.id}`;
                        cell.classList.add('editable-field-container');
                        cell.classList.add('date-input-container');

                        const select = document.createElement('select');
                        select.setAttribute('data-initial-value', value);
                        select.placeholder = value;
                        select.id = `${columnName}${record.id}`;

                        select.addEventListener('change', (e) => atualizarDados(e));

                        const optionPlaceholder = document.createElement('option');
                        optionPlaceholder.textContent = '-- Selecione o respons√°vel --';
                        optionPlaceholder.disabled = true;
                        optionPlaceholder.selected = !value;
                        select.appendChild(optionPlaceholder);

                        cell.appendChild(select);
                        const responsaveis = responsaveisPorPais[record.country]

                        if (responsaveis) {
                            responsaveis.forEach(responsavel => {
                                const opt = document.createElement('option');
                                opt.textContent = capitalizeFirstLetter(responsavel.name);
                                opt.value = responsavel.name; // ou responsavel.id se preferir
                                if (value && responsavel.name.toUpperCase() === value.toUpperCase()) {
                                    opt.selected = true;
                                }
                                select.appendChild(opt);
                            });
                        }

                    } else if (headerInfo.isTextAreaColumn) {
                        cell.id = `${columnName}${record.id}`
                        cell.classList.add('editable-field-container')
                        cell.classList.add('date-input-container')

                        let textArea = document.createElement('textarea')
                        textArea.setAttribute('data-initial-value', value)
                        textArea.rows = 5
                        textArea.cols = 20
                        textArea.placeholder = value
                        textArea.id = `${columnName}${record.id}`
                        textArea.addEventListener('input', (e) => atualizarDados(e))
                        textArea.addEventListener('dblclick', (e) => {
                            navigator.clipboard.writeText(e.target.getAttribute('data-initial-value'))
                            Swal.fire({
                                title: "Texto copiado",
                                text: 'Feedback copiado para √°rea de transfer√™ncia',
                                showCloseButton: true,
                                icon: 'success'
                            })
                        })
                        cell.appendChild(textArea)

                    } else {
                        cell.textContent = (value !== null && value !== undefined) ? value : "";
                    }
                });
            });
            // Configura os observadores ap√≥s renderizar a tabela
            setTimeout(() => {
                setupDateInputObservers();
                if (!statusUpdateSystem.isInitialized) {
                    recalculateAllStatus();
                    statusUpdateSystem.isInitialized = true;
                }
                
                // HOOK: Inicializar observers China para registros com status China
                records.forEach(record => {
                    if (record.status === 'Aguardando China' || record.status === 'China Atrasada') {
                        chinaStatusObserver.observe(record.id, record);
                    }
                });
            }, 100);
        }

        // Fun√ß√£o para inicializar o sistema de atualiza√ß√£o din√¢mica
        function initializeStatusUpdateSystem() {
            //console.log('Sistema de atualiza√ß√£o din√¢mica de status inicializado');
            
            // Configura um observer global para detectar mudan√ßas na p√°gina
            const globalObserver = new MutationObserver((mutations) => {
                let hasTableChanges = false;
                
                mutations.forEach((mutation) => {
                    if (mutation.target.id === 'table-body' || 
                        mutation.target.closest('#table-body')) {
                        hasTableChanges = true;
                    }
                });
                
                if (hasTableChanges) {
                    debounce(() => {
                        setupDateInputObservers();
                    }, 200, 'global-table-change');
                }
            });
            
            // Observa mudan√ßas em toda a p√°gina
            globalObserver.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            statusUpdateSystem.observers.set('global', globalObserver);
        }

        // Inicializa o sistema quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeStatusUpdateSystem);
        } else {
            initializeStatusUpdateSystem();
        }



        // --- Inicializa√ß√£o ---
        //console.log("Inicializando event listeners para cabe√ßalhos...");
        headerData.forEach((headerInfo) => {
            const { element: headerElement, filterBox: filterBoxElement, columnName } = headerInfo;
            if (filterBoxElement) { 
                //console.log(`Adicionando listener de clique para ${columnName}`);
                filterBoxElement.id = `filter-box-${columnName}`;
                headerElement.addEventListener("click", (event) => {
                    //console.log(`Clique detectado no cabe√ßalho ${columnName}`);
                    if (event.target.closest(".filter-box")) {
                        //console.log("Clique dentro da filter-box, ignorando.");
                        return; 
                    }
                    if (openFilterBox && openFilterBox !== filterBoxElement) {
                        //console.log("Fechando outra filter-box aberta.");
                        openFilterBox.style.display = "none";
                    }
                    const isCurrentlyOpen = filterBoxElement.style.display === "block";
                    if (isCurrentlyOpen) {
                        //console.log(`Fechando filter-box para ${columnName}`);
                        filterBoxElement.style.display = "none";
                        openFilterBox = null;
                    } else {
                        //console.log(`Abrindo filter-box para ${columnName}`);
                        // *** AGORA POPULA COM OP√á√ïES DIN√ÇMICAS ***
                        populateFilterBox(filterBoxElement, headerInfo); 
                        
                        filterBoxElement.style.display = "block";
                        positionFilterBox(headerElement, filterBoxElement);
                        openFilterBox = filterBoxElement;
                        const searchInput = filterBoxElement.querySelector(".filter-search-input");
                        if (searchInput) searchInput.focus();
                    }
                    event.stopPropagation(); 
                });
            } else {
                 //console.log(`Sem filter-box para ${columnName}, listener n√£o adicionado.`);
            }
        });

        // Listener para fechar a caixa ao clicar fora
        document.addEventListener("click", (event) => {
            if (
                openFilterBox &&
                !event.target.closest("th") && 
                !openFilterBox.contains(event.target) 
            ) {
                //console.log("Clique fora, fechando filter-box.");
                openFilterBox.style.display = "none";
                openFilterBox = null;
            }
        });
        
        // Chama para carregar dados iniciais via AJAX
        //console.log("Chamando applyFiltersAndSort para carregamento inicial...");
        applyFiltersAndSort(false); 

        let typingTimer;
        const doneTypingInterval = 100;

        function atualizarDados(e){   
            clearTimeout(typingTimer);   
            let dado = e.target ? e.target : e
                
            let valor_inicial = dado.getAttribute('data-initial-value')
            let valor_input = dado.value
            if(valor_input !== valor_inicial) {
                dado.classList.add('pending-save')
                typingTimer = setTimeout(() => saveField(dado), doneTypingInterval);
            }
            
        }
        function saveField(inputElement) {
            const container = inputElement.closest('.editable-field-container') ? inputElement.closest('.editable-field-container') : inputElement.closest('.field-container');
            const reportID = container.getAttribute('data-id');
            const fieldName = container.getAttribute('data-column');
            const newValue = inputElement.value
            
            fetch('{% url "update_ocorrencia" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'  // Envia o CSRF token no cabe√ßalho
                },
                body: JSON.stringify({
                    id: reportID,
                    field: fieldName,
                    value: newValue,
                    page_num: page_num
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na requisi√ß√£o');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    inputElement.classList.remove('pending-save', 'saving');
                    inputElement.setAttribute('data-initial-value', newValue);
                    
                    // Atualiza o display se necess√°rio
                    if (data.display_value) {
                        inputElement.value = data.display_value;
                        inputElement.setAttribute('placeholder', data.display_value);
                        inputElement.dataset.initialValue = data.display_value;
                    }
                }
                // location.reload();
                page_num = data.page_num
                setTimeout(() => inputElement.classList.remove('success'), 5000);
            })
            .catch(error => {
                console.error('Erro:', error.message);
                inputElement.classList.remove('saving');
                inputElement.classList.add('error');
                setTimeout(() => inputElement.classList.remove('error'), 5000);
            });
    

        }
        
    

    });
    
    // Ap√≥s defini√ß√£o de todas as fun√ß√µes:
    
    // Sistema de Notifica√ß√µes
    let notificationsVisible = false;
    
    function toggleNotifications() {
        const dropdown = document.getElementById('notification-dropdown');
        notificationsVisible = !notificationsVisible;
        
        if (notificationsVisible) {
            dropdown.style.display = 'block';
            carregarNotificacoes();
        } else {
            dropdown.style.display = 'none';
        }
    }
    
    function carregarNotificacoes() {
        fetch('/ocorrencia/notificacoes/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                exibirNotificacoes(data.notificacoes);
            }
        })
        .catch(error => {
            console.error('Erro ao carregar notifica√ß√µes:', error);
        });
    }
    
    function exibirNotificacoes(notificacoes) {
        const notificationList = document.getElementById('notification-list');
        
        if (notificacoes.length === 0) {
            notificationList.innerHTML = '<div class="no-notifications">Nenhuma notifica√ß√£o</div>';
            return;
        }
        
        let html = '';
        notificacoes.forEach(notificacao => {
            html += `
                <div class="notification-item" onclick="actionsOcorrencia(${notificacao.record_id},${notificacao.id})">
                    <div class="notification-title">${notificacao.titulo}</div>
                    <div class="notification-summary">
                        ${notificacao.resumo}
                        <button
                            type="button"
                            class="notification-mark-read"
                            title="Marcar como lida"
                            aria-label="Marcar notifica√ß√£o como lida"
                            onclick="event.stopPropagation(); lerOcorrencia(${notificacao.id});"
                            >
                            Marcar lida
                        </button>
                    </div>
                    <div class="notification-time">${notificacao.criada_em}</div>
                </div>
            `;
        });
        
        notificationList.innerHTML = html;
    }
    function actionsOcorrencia(recordId, notificacaoId){
        lerOcorrencia(notificacaoId)
        abrirOcorrencia(recordId)
    }
    function lerOcorrencia(notificacaoId){
        // Marcar notifica√ß√£o como lida
        fetch(`/ocorrencia/notificacoes/${notificacaoId}/marcar_lida/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(() => {
            // Atualizar contador de notifica√ß√µes
            atualizarContadorNotificacoes();
            // Fechar dropdown
            document.getElementById('notification-dropdown').style.display = 'none';
            notificationsVisible = false;
        });
    }
    function abrirOcorrencia(recordId) {
        // Buscar e exibir detalhes da ocorr√™ncia
        fetch(`/ocorrencia/get_record/${recordId}/`)
        .then(response => response.json())
        .then(record => {
            showProblemDetails(record);
        })
        .catch(error => {
            console.error('Erro ao buscar ocorr√™ncia:', error);
            alert('Erro ao carregar detalhes da ocorr√™ncia.');
        });
    }
    
    function atualizarContadorNotificacoes() {
        fetch('/ocorrencia/notificacoes/contar/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const badge = document.getElementById('notification-badge');
                if (data.count > 0) {
                    badge.textContent = data.count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        })
        .catch(error => {
            console.error('Erro ao contar notifica√ß√µes:', error);
        });
    }
    
    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function(event) {
        const container = document.querySelector('.notification-container');
        if (!container.contains(event.target)) {
            document.getElementById('notification-dropdown').style.display = 'none';
            notificationsVisible = false;
        }
    });
    
    // Carregar contador de notifica√ß√µes ao carregar a p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        atualizarContadorNotificacoes();
        
        const notificationSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/notifications/'
        );

        notificationSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            // console.log("Evento de notifica√ß√£o recebido:", data);
            if (data.type === 'chat_notification') {
                // A sua fun√ß√£o j√° existente para atualizar o contador
                atualizarContadorNotificacoes();
            }
        };
    });
        document.addEventListener("change", function(event) {
            if (event.target.classList.contains("editable-select-status")) {
                const selectElement = event.target;
                const recordID = selectElement.getAttribute("data-record-id");
                const fieldName = selectElement.getAttribute("data-field-name");
                const newValue = selectElement.value;

                fetch("{% url 'update_ocorrencia' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie('csrftoken'),
                    },
                    body: JSON.stringify({
                        id: recordID,
                        field: fieldName,
                        value: newValue,
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        // HOOK: Atualizar observers China quando status √© alterado
                        const record = statusUpdateSystem.records.find(r => r.id == recordID);
                        if (record) {
                            record.status = newValue; // Atualiza o status no record local
                            
                            // Se o novo status √© relacionado √† China, adiciona ao observer
                            if (newValue === 'Aguardando China' || newValue === 'China Atrasada') {
                                chinaStatusObserver.observe(recordID, record);
                            } else {
                                // Se n√£o √© mais status China, remove do observer
                                chinaStatusObserver.unobserve(recordID);
                            }
                        }
                        
                        applyFiltersAndSort(); // Atualiza a tabela principal
                        // Opcional: Atualizar o pop-up se ele ainda estiver aberto
                        // Swal.update({ html: updatedPopupContent });
                    } else {
                        Swal.fire("Erro", data.message || "Erro desconhecido ao atualizar status.", "error");
                    }
                })
                .catch(error => {
                    console.error("Erro ao salvar status no pop-up:", error);
                    Swal.fire("Erro de Rede", "N√£o foi poss√≠vel conectar ao servidor para atualizar o status.", "error");
                });
            }
        });
</script>

<!-- Modal para expandir imagens -->
<div id="image-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;">
    <div style="position: relative; max-width: 90%; max-height: 90%;">
        <img id="expanded-image" src="" style="max-width: 100%; max-height: 100%; border-radius: 8px;">
        <div style="position: absolute; top: -50px; right: 0; display: flex; gap: 10px;">
            <button id="download-image" style="background: #28a745; color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer; font-size: 14px;">
                ‚¨áÔ∏è Download
            </button>
            <button id="close-modal" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px;">√ó</button>
        </div>
    </div>
</div>

</body>
</html>
